<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Present Tense Practice</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  /* User-friendly palette (soft, high contrast) */
  --bg-top:#f6f8ff;
  --bg-bottom:#e9fbff;

  --panel:#ffffff;
  --text:#132238;
  --muted:#5a6a7a;

  --ps:#3b82f6;     /* blue */
  --pc:#14b8a6;     /* teal */
  --card1:#fb7185;  /* pink */
  --card2:#f97316;  /* orange */
  --accent:#7c3aed; /* purple */

  --success:#15803d;
  --error:#b91c1c;

  --stroke: rgba(15, 23, 42, .10);
  --shadow: 0 24px 60px rgba(2,6,23,0.18);

  --gameMax: 720px;
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Montserrat,system-ui,sans-serif;
  background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  color:var(--text);
}

.container{
  width:min(1040px, 100%);
  height:min(860px, calc(100vh - 36px));
  background:var(--panel);
  border-radius:16px;
  padding:16px;
  box-shadow:var(--shadow);
  display:grid;
  grid-template-columns: 1fr 260px;
  grid-template-rows:auto auto 1fr auto;
  gap:12px;
  overflow:hidden;
}

/* Header */
.header{
  grid-column:1/2;
  grid-row:1/2;
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:62px;height:62px;border-radius:14px;
  background:linear-gradient(180deg,#ffffff,#fff7fb);
  display:flex;align-items:center;justify-content:center;
  border:1px solid var(--stroke);
  box-shadow:0 10px 24px rgba(2,6,23,0.08);
}
.title{font-size:20px;color:var(--accent);margin:0}
.lead{color:var(--muted);font-size:13px;margin:2px 0 0}

/* Right panel */
.controlsPanel{
  grid-column:2/3;
  grid-row:1/3;
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:stretch;
  justify-content:flex-start;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg,#ffffff,#fbfdff);
}
.inputRow{display:flex;flex-direction:column;gap:6px;width:100%}
.inputRow label{font-weight:800;font-size:13px;color:var(--text)}
.inputRow input[type="text"], .inputRow input[type="number"], .inputRow select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(15,23,42,.14);
  font-size:14px;
  outline:none;
}
.inputRow input:focus{
  border-color: rgba(124,58,237,.55);
  box-shadow:0 0 0 4px rgba(124,58,237,.14);
}
.lockedHint{
  font-size:12px;color:var(--muted);
  margin-top:-4px;
}

/* Topbar */
.topbar{
  grid-column:1/2;
  grid-row:2/3;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg,#ffffff,#fbfdff);
}
.statBox{
  background:#fff;
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--stroke);
  font-weight:800;
  font-size:13px;
}

/* Game area */
.game{
  grid-column:1/2;
  grid-row:3/4;
  display:flex;
  justify-content:center;
  overflow:auto;
  padding-right:6px;
}
.gameInner{
  width:min(var(--gameMax), 100%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:2px 2px 10px;
}

/* Game card (more proportional + visible header) */
#card{
  width:100%;
  height:clamp(220px, 30vh, 300px);
  border-radius:16px;
  padding:18px;
  background:linear-gradient(135deg,var(--card1),var(--card2));
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  flex-direction:column;
  box-shadow:0 14px 40px rgba(2,6,23,0.18);
  position:relative;
  overflow:hidden;
}
#cardLabel{
  font-size:14px;
  font-weight:900;
  color:#fff;
  margin:0 0 10px;
  padding:10px 12px;
  border-radius:999px;
  background:rgba(255,255,255,0.18);
  border:1px solid rgba(255,255,255,0.22);
  backdrop-filter: blur(6px);
}
#cardText{
  font-size:30px;
  font-weight:900;
  color:#fff;
  line-height:1.08;
  word-break:break-word;
  max-width:100%;
}

/* Order box and options */
#orderBox{
  width:100%;
  min-height:84px;
  background:#fff;
  border-radius:14px;
  padding:12px;
  border:1px solid var(--stroke);
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:var(--text);
  font-size:18px;
}
#options{
  width:100%;
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  justify-content:center;
}

/* Buttons */
button{outline:none}
button:focus{
  box-shadow:0 0 0 4px rgba(124,58,237,.18);
}
button:disabled{
  opacity:.65;
  cursor:not-allowed;
  transform:none !important;
}

.btn-ps{
  background:linear-gradient(180deg,var(--ps),#2563eb);
  color:#fff;border:none;
  padding:14px 26px;border-radius:16px;
  font-weight:900;cursor:pointer;
  font-size:18px;
  box-shadow:0 10px 26px rgba(2,6,23,0.12);
}
.btn-pc{
  background:linear-gradient(180deg,var(--pc),#0f766e);
  color:#fff;border:none;
  padding:14px 26px;border-radius:16px;
  font-weight:900;cursor:pointer;
  font-size:18px;
  box-shadow:0 10px 26px rgba(2,6,23,0.12);
}
.btn-ps:hover,.btn-pc:hover{transform:translateY(-2px);opacity:0.98}
.choice-chosen{background:linear-gradient(180deg,#ef4444,#b91c1c) !important;color:#fff !important}

/* Word tags */
.orderWord{
  background:linear-gradient(180deg,#60a5fa,#2563eb);
  color:#fff;border:none;
  padding:12px 16px;border-radius:14px;
  font-weight:900;font-size:18px;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(2,6,23,0.10);
}
.orderWord.chosen{background:linear-gradient(180deg,#ef4444,#b91c1c)}

/* Progress bar (smaller) */
.progressWrap{
  width:100%;
  height:10px; /* smaller */
  background:#eef2ff;
  border-radius:999px;
  overflow:hidden;
  border:1px solid var(--stroke);
  display:flex;
  align-items:center;
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  transition:width 600ms ease;
}
.progressLabel{font-size:12px;color:var(--muted);margin-top:4px}

/* Feedback */
#feedback{
  min-height:56px;
  text-align:center;
  font-weight:900;
  margin-top:6px;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  color:var(--text);
}

/* Controls row */
.controlsRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:center;
  margin-top:6px;
}
.btnPrimary{
  background:linear-gradient(180deg,var(--accent),#5b21b6);
  color:#fff;
  padding:12px 18px;
  border-radius:14px;
  border:none;
  font-weight:900;
  cursor:pointer;
}
.btnSecondary{
  background:#fff;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--stroke);
  cursor:pointer;
  color:var(--text);
  font-weight:800;
}

/* Footer */
.footer{
  grid-column:1/2;
  grid-row:4/5;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-top:2px;
}
.small{font-size:13px;color:var(--muted)}

/* Celebration overlay */
.celebration-overlay{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(2,8,23,0.55);
  z-index:9999;
  flex-direction:column;
  padding:20px;
}
.celebration-card{
  background:linear-gradient(180deg,#fff,#fffefc);
  color:var(--text);
  border-radius:18px;
  padding:28px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.45);
  max-width:760px;width:100%;
}
.celebration-title{font-size:34px;font-weight:900;color:var(--accent);margin-bottom:8px}
.celebration-actions{display:flex;gap:12px;justify-content:center;margin-top:12px}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Practica tiempos">
    <!-- Left header -->
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="40" height="40" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#a78bfa"/>
              <stop offset="1" stop-color="#fb7185"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Present Tense Practice</h1>
        <p class="lead">Present Simple & Present Continuous ‚Äî estructuras variadas</p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="statBox" id="score">Score: 0</div>
        <div class="statBox" id="timer">Time: 0s</div>
        <div class="statBox" id="streakBox">Streak: 0</div>
      </div>
      <div style="font-size:13px;color:var(--muted)">Jugador: <strong id="playerName">‚Äî</strong></div>
    </div>

    <!-- Right controls panel -->
    <div class="controlsPanel" aria-hidden="false">
      <div class="inputRow">
        <label for="studentName">Nombre del estudiante</label>
        <input id="studentName" type="text" placeholder="Escribe tu nombre (ej. Laura)">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Objetivo de racha (aciertos seguidos)</label>
        <!-- Fijo a 25, como pediste -->
        <input id="targetStreak" type="number" min="25" value="25" disabled>
        <div class="lockedHint">Objetivo fijado en 25 aciertos seguidos ‚úÖ</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;width:100%;justify-content:center">
        <button id="startBtn" class="btnPrimary" style="width:48%">START</button>
        <button id="resetBtn" class="btnSecondary" style="width:48%">RESET</button>
      </div>

      <label style="font-size:13px;color:var(--muted);margin-top:6px">
        <input id="soundToggle" type="checkbox" checked> Efectos de sonido
      </label>

      <div style="margin-top:auto;font-size:12px;color:var(--muted);line-height:1.35">
        Tip: En ‚ÄúOrder the sentence‚Äù, puedes pulsar una palabra ya puesta (en la caja blanca) para deshacer.
      </div>
    </div>

    <!-- Game area -->
    <div class="game" role="main" aria-live="polite">
      <div class="gameInner">
        <div id="card" role="region" aria-label="Tarjeta de frase">
          <div id="cardLabel">Identifica el tiempo o ordena la frase</div>
          <div id="cardText">Pulsa START para comenzar</div>
        </div>

        <div id="orderBox" aria-live="polite">Las palabras seleccionadas aparecer√°n aqu√≠.</div>

        <div id="options" role="group" aria-label="Opciones"></div>

        <div class="progressWrap" aria-hidden="false" style="margin-top:4px">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Progreso 0%</div>

        <div id="feedback" aria-live="assertive"></div>

        <div class="controlsRow">
          <button id="resetOrder" class="btnSecondary" style="display:none">Reiniciar orden</button>
          <button id="nextBtn" class="btnSecondary" style="display:none">Siguiente</button>
          <button id="downloadReport" class="btnSecondary" style="display:none">Descargar informe (CSV)</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div class="small">Banco: Present Simple / Present Continuous ‚Äî 6 categor√≠as</div>
      <div class="small">Objetivo actual: <span id="targetLabel">25</span> aciertos seguidos</div>
    </div>

    <!-- Celebration overlay -->
    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">¬°Felicidades!</div>
        <div id="celebrationSub" class="small">Has alcanzado la racha objetivo.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary">Descargar informe</button>
          <button id="celebrationRestart" class="btnSecondary">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Bancos (6 x 20) ---------- */
const PS_aff = ["She usually walks to school.","He plays the guitar every afternoon.","They enjoy quiet mornings together.","My cat sleeps on my backpack.","I like how this coffee smells.","We read the newspaper every morning.","The bus arrives at eight o'clock.","Tom studies French at university.","Anna works in a small bakery.","Birds fly south in winter.","The shop opens at nine every day.","He drinks green tea after lunch.","Students practice vocabulary every evening.","She always helps her neighbors.","The sun rises in the east.","He writes emails every morning.","We celebrate birthdays with cake.","The teacher explains the lesson clearly.","She takes the dog for a walk daily.","They visit the museum on weekends."];
const PS_neg = ["She doesn't like cold pizza.","They don't study on Sundays.","He does not enjoy long movies.","I don't drink soda anymore.","The cat doesn't sleep in its bed.","We don't watch TV at night.","He doesn't own a car.","She does not eat meat.","They don't arrive early.","I don't understand this word.","She doesn't answer her phone often.","We don't use that old computer anymore.","He doesn't believe the rumor.","They don't accept late homework.","I don't remember his name.","She doesn't drive to work.","He doesn't like loud music.","We don't go out when it rains.","The store doesn't open on Sundays.","He doesn't speak Spanish."];
const PS_int = ["Do you like spicy food?","Does she play the violin?","Do they live near here?","Does he enjoy swimming?","Do we have class today?","Do you speak English?","Does it rain a lot here?","Do they know the answer?","Does she work on Saturdays?","Do I need to bring a book?","Do you usually study in the morning?","Does he visit his grandparents every week?","Do they play chess after school?","Does she cook for the family?","Do we meet at the library?","Do you understand the instructions?","Does he take the train to work?","Do they practice every day?","Does she prefer tea or coffee?","Do I have to finish this today?"];
const PC_aff = ["She's studying English right now.","They are cooking dinner together.","He's drawing a robot at the moment.","I'm listening to music.","We're walking to the bus stop.","She is reading a new novel.","They are playing football in the park.","He is fixing his bicycle.","I'm watching a documentary.","We are preparing for the exam.","She is practicing the piano this afternoon.","They are building a model in the workshop.","He is cleaning his room right now.","I'm checking my email at the moment.","We are learning a new song today.","She is talking on the phone now.","They are planting flowers in the garden.","He is repairing the fence this morning.","I'm making a sandwich right now.","We are discussing the project together."];
const PC_neg = ["She isn't studying for the test right now.","They aren't watching TV at the moment.","He is not working today.","I'm not feeling well this morning.","We aren't using the old printer now.","She isn't listening to the radio.","They aren't playing the piano today.","He isn't driving to the office this week.","I'm not eating meat this week.","We aren't meeting them tonight.","She isn't wearing her new coat today.","They aren't staying at the hotel this time.","He is not answering his phone now.","I'm not taking the bus today.","We aren't studying that chapter now.","She isn't practicing the song today.","They aren't building the shelf this afternoon.","He isn't fixing the car right now.","I'm not watching the match at the moment.","We aren't preparing dinner yet."];
const PC_int = ["Is she studying English now?","Are they cooking dinner together?","Is he drawing a robot at the moment?","Am I listening to the right track?","Are we walking to the bus stop?","Is she reading a new novel now?","Are they playing football in the park?","Is he fixing his bicycle right now?","Am I watching the documentary?","Are we preparing for the exam?","Is she practicing the piano this afternoon?","Are they building a model in the workshop?","Is he cleaning his room at the moment?","Am I checking my email now?","Are we learning a new song today?","Is she talking on the phone now?","Are they planting flowers in the garden?","Is he repairing the fence this morning?","Am I making a sandwich right now?","Are we discussing the project together?"];

/* ---------- Estado ---------- */
let pools = null;
let current = {};
let score = 0;
let timer = 0;
let timerInterval = null;
let playerName = "";
let consecutiveCorrect = 0;

/* Fijo a 25 como pediste */
const TARGET_STREAK_FIXED = 25;
let TARGET_STREAK = TARGET_STREAK_FIXED;

let attemptsLog = [];
let soundEnabled = true;

/* ---------- Audio (resumido con gesto de usuario) ---------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
async function ensureAudioReady(){
  try{
    if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
  }catch(_){}
}
function playTone(type){
  if(!soundEnabled || !audioCtx) return;
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);

  if(type === 'correct'){
    o.frequency.setValueAtTime(880, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.01);
    o.frequency.exponentialRampToValueAtTime(1320, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  } else {
    o.frequency.setValueAtTime(220, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.08, now+0.01);
    o.frequency.exponentialRampToValueAtTime(160, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  }
  o.start(now); o.stop(now+0.3);
}

/* ---------- Utilidades ---------- */
function clearTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }
function startTimer(){
  clearTimer();
  timer = 0;
  document.getElementById("timer").textContent = "Time: 0s";
  timerInterval = setInterval(()=>{
    timer++;
    document.getElementById("timer").textContent = "Time: " + timer + "s";
  },1000);
}
function normalizeString(s){
  if(!s) return "";
  return s.replace(/[\u2018\u2019\u201C\u201D]/g,"'")
          .replace(/[?.,!;:()"]/g,"")
          .replace(/\s+/g," ")
          .trim()
          .toLowerCase();
}
function shuffleArray(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ---------- Pools ---------- */
function buildPools(){
  pools = {
    aff: shuffleArray(PS_aff.slice()),
    neg: shuffleArray(PS_neg.slice()),
    int: shuffleArray(PS_int.slice()),
    contAff: shuffleArray(PC_aff.slice()),
    contNeg: shuffleArray(PC_neg.slice()),
    contInt: shuffleArray(PC_int.slice())
  };
}

/* ---------- Progreso ---------- */
function setProgressPercent(pct){
  pct = Math.max(0, Math.min(100, Math.round(pct)));
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = 'Progreso ' + pct + '%';
}

/* ---------- UI: START / RESET ---------- */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  await ensureAudioReady();

  const nameInput = document.getElementById('studentName').value.trim();
  if(!nameInput){
    alert('Introduce el nombre del estudiante en el campo de la derecha.');
    document.getElementById('studentName').focus();
    return;
  }

  playerName = nameInput;
  TARGET_STREAK = TARGET_STREAK_FIXED; // fijo 25
  document.getElementById('targetStreak').value = TARGET_STREAK_FIXED;
  document.getElementById('targetLabel').textContent = TARGET_STREAK_FIXED;

  document.getElementById('playerName').textContent = playerName;
  consecutiveCorrect = 0;
  score = 0;
  attemptsLog = [];

  document.getElementById('score').textContent = 'Score: 0';
  document.getElementById('streakBox').textContent = 'Streak: 0';

  setProgressPercent(0);
  buildPools();

  soundEnabled = document.getElementById('soundToggle').checked;
  nextQuestion();
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  clearTimer();
  document.getElementById('studentName').value = '';
  document.getElementById('targetStreak').value = TARGET_STREAK_FIXED;

  playerName = '';
  document.getElementById('playerName').textContent = '‚Äî';

  consecutiveCorrect = 0; score = 0; attemptsLog = [];
  document.getElementById('score').textContent = 'Score: 0';
  document.getElementById('timer').textContent = 'Time: 0s';
  document.getElementById('streakBox').textContent = 'Streak: 0';

  setProgressPercent(0);
  document.getElementById('cardLabel').textContent = 'Identifica el tiempo o ordena la frase';
  document.getElementById('cardLabel').style.display = 'block';
  document.getElementById('cardText').textContent = 'Pulsa START para comenzar';
  document.getElementById('options').innerHTML = '';
  document.getElementById('orderBox').innerHTML = 'Las palabras seleccionadas aparecer√°n aqu√≠.';
  document.getElementById('feedback').textContent = '';

  document.getElementById('downloadReport').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('resetOrder').style.display = 'none';
});

/* ---------- Siguiente pregunta ---------- */
function nextQuestion(){
  if(consecutiveCorrect >= TARGET_STREAK) return;

  clearTimer();
  clearFeedback();

  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('resetOrder').style.display = 'none';

  document.getElementById('orderBox').innerHTML = '';
  document.getElementById('options').innerHTML = '';
  document.getElementById('cardText').textContent = '';
  document.getElementById('cardLabel').style.display = 'block';

  const chooseContinuous = Math.random() < 0.5;
  if(chooseContinuous){
    const types = ['contAff','contNeg','contInt'];
    const chosen = types[Math.floor(Math.random()*types.length)];
    if(!pools || !pools[chosen] || pools[chosen].length === 0) buildPools();
    const text = pools[chosen].pop();
    current = { text, correct: 'Present Continuous', structure: chosen, mode: Math.random() < 0.5 ? 'multiple' : 'order', typed: [], startTime: Date.now() };
  } else {
    const types = ['aff','neg','int'];
    const chosen = types[Math.floor(Math.random()*types.length)];
    if(!pools || !pools[chosen] || pools[chosen].length === 0) buildPools();
    const text = pools[chosen].pop();
    current = { text, correct: 'Present Simple', structure: chosen, mode: Math.random() < 0.5 ? 'multiple' : 'order', typed: [], startTime: Date.now() };
  }

  renderQuestion();
}

/* ---------- Render ---------- */
function renderQuestion(){
  startTimer();

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';

  // reset label per mode (evita quedarse en "Order the sentence")
  if(current.mode === 'multiple'){
    document.getElementById('cardLabel').textContent = 'Elige el tiempo verbal';
    document.getElementById('cardText').textContent = current.text;

    const psBtn = document.createElement('button');
    psBtn.className = 'btn-ps';
    psBtn.textContent = 'Present Simple';
    psBtn.onclick = ()=> checkAnswer('Present Simple');

    const pcBtn = document.createElement('button');
    pcBtn.className = 'btn-pc';
    pcBtn.textContent = 'Present Continuous';
    pcBtn.onclick = ()=> checkAnswer('Present Continuous');

    optionsDiv.appendChild(psBtn);
    optionsDiv.appendChild(pcBtn);

    document.getElementById('orderBox').textContent = 'Pulsa una opci√≥n para responder.';
  } else {
    document.getElementById('cardLabel').textContent = 'Order the sentence';
    document.getElementById('cardText').textContent = '';
    document.getElementById('resetOrder').style.display = 'inline-block';
    document.getElementById('resetOrder').onclick = resetOrder;

    const cleaned = current.text.replace(/[\u2018\u2019\u201C\u201D]/g,"'");
    const words = cleaned.replace(/[?.,!;:()"]/g,"").split(/\s+/).filter(Boolean);

    if(words.length <= 1){
      current.mode = 'multiple';
      renderQuestion();
      return;
    }

    let shuffled;
    let attempts = 0;
    do{
      shuffled = shuffleArray(words);
      attempts++;
      if(attempts>12) break;
    } while(shuffled.join(' ') === words.join(' '));

    current.originalWords = words;
    current.shuffledWords = shuffled;
    current.typed = [];

    shuffled.forEach((w, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'orderWord';
      btn.textContent = w;
      btn.dataset.idx = idx;
      btn.onclick = ()=> pickWord(w, btn);
      optionsDiv.appendChild(btn);
    });

    updateOrderBox();
  }
}

/* ---------- Order helpers ---------- */
function updateOrderBox(){
  const box = document.getElementById('orderBox');
  box.innerHTML = '';
  if(!current || !current.typed || current.typed.length === 0){
    box.textContent = 'Selected words will appear here (click a selected word to undo).';
    return;
  }
  current.typed.forEach((w,i)=>{
    const span = document.createElement('span');
    span.textContent = w;
    span.style.padding='8px 10px';
    span.style.margin='6px';
    span.style.borderRadius='12px';
    span.style.background='#eef2ff';
    span.style.fontWeight='800';
    span.style.cursor='pointer';
    span.onclick = ()=> undoWord(i);
    box.appendChild(span);
  });
}
function undoWord(index){
  const optionsDiv = document.getElementById('options');
  const buttons = Array.from(optionsDiv.querySelectorAll('button'));
  buttons.forEach(b => { b.disabled = false; b.classList.remove('chosen'); });

  current.typed = current.typed.slice(0, index);

  // re-disable selected
  buttons.forEach(b=>{
    if(current.typed.includes(b.textContent)){
      b.classList.add('chosen');
      b.disabled = true;
    }
  });

  updateOrderBox();
  showFeedback('Palabra eliminada. Contin√∫a.', 'neutral');
}
function resetOrder(){
  current.typed = [];
  const optionsDiv = document.getElementById('options');
  Array.from(optionsDiv.querySelectorAll('button')).forEach(b=>{
    b.disabled = false;
    b.classList.remove('chosen');
  });
  updateOrderBox();
  showFeedback('Orden reiniciado.', 'neutral');
}

/* ---------- Logging ---------- */
function logAttempt(entry){
  attemptsLog.push(entry);
  document.getElementById('downloadReport').style.display = 'inline-block';
}

/* ---------- Correct / Incorrect ---------- */
function handleCorrect(selected){
  score++;
  consecutiveCorrect++;

  document.getElementById('score').textContent = 'Score: ' + score;
  document.getElementById('streakBox').textContent = 'Streak: ' + consecutiveCorrect;

  showFeedback('¬°Correcto! Bien hecho.', 'success');
  playTone('correct');

  clearTimer();
  document.querySelectorAll('#options button').forEach(b=>b.disabled=true);

  document.getElementById('nextBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').onclick = nextQuestion;

  const timeTaken = Math.round((Date.now() - current.startTime)/1000);
  logAttempt({
    timestamp: new Date().toISOString(),
    student: playerName,
    sentence: current.text,
    mode: current.mode,
    structure: current.structure,
    selected: selected || '',
    correctLabel: current.correct,
    correct: true,
    timeTaken,
    streak: consecutiveCorrect
  });

  setProgressPercent((consecutiveCorrect / TARGET_STREAK) * 100);

  if(consecutiveCorrect >= TARGET_STREAK){
    showCelebration();
  }
}

function pickWord(word, btn){
  if(btn.disabled) return;

  btn.classList.add('chosen');
  btn.disabled = true;

  current.typed.push(word);
  updateOrderBox();

  const typed = normalizeString(current.typed.join(' '));
  const correct = normalizeString(current.originalWords.join(' '));

  if(typed === correct){
    document.getElementById('cardLabel').style.display = 'none';
    document.getElementById('cardText').textContent = current.originalWords.join(' ');
    handleCorrect(current.typed.join(' '));
    return;
  }

  if(current.typed.length === current.originalWords.length){
    // incorrect full order
    consecutiveCorrect = 0;
    document.getElementById('streakBox').textContent = 'Streak: 0';
    setProgressPercent(0);

    showFeedback('Incorrecto. Se muestra la frase correcta.', 'error');
    document.getElementById('cardLabel').style.display = 'none';
    document.getElementById('cardText').textContent = current.originalWords.join(' ');
    playTone('incorrect');

    clearTimer();
    document.querySelectorAll('#options button').forEach(b=>b.disabled=true);

    document.getElementById('nextBtn').style.display = 'inline-block';
    document.getElementById('nextBtn').onclick = nextQuestion;

    const timeTaken = Math.round((Date.now() - current.startTime)/1000);
    logAttempt({
      timestamp: new Date().toISOString(),
      student: playerName,
      sentence: current.text,
      mode: current.mode,
      structure: current.structure,
      selected: current.typed.join(' '),
      correctLabel: current.correct,
      correct: false,
      timeTaken,
      streak: consecutiveCorrect
    });
    return;
  }

  showFeedback('Sigue seleccionando...', 'neutral');
}

function checkAnswer(choice){
  if(choice === current.correct){
    document.getElementById('cardText').textContent = current.text;
    handleCorrect(choice);
  } else {
    consecutiveCorrect = 0;
    document.getElementById('streakBox').textContent = 'Streak: 0';
    setProgressPercent(0);

    showFeedback('Intenta de nuevo', 'error');
    playTone('incorrect');

    const timeTaken = Math.round((Date.now() - current.startTime)/1000);
    logAttempt({
      timestamp: new Date().toISOString(),
      student: playerName,
      sentence: current.text,
      mode: current.mode,
      structure: current.structure,
      selected: choice,
      correctLabel: current.correct,
      correct: false,
      timeTaken,
      streak: consecutiveCorrect
    });

    const btns = Array.from(document.querySelectorAll('#options button'));
    btns.forEach(b => { if(b.textContent === choice) b.classList.add('choice-chosen'); });
  }
}

/* ---------- Feedback ---------- */
function showFeedback(text, type){
  const fb = document.getElementById('feedback');
  fb.className = '';
  if(type === 'success'){
    fb.innerHTML = `<span style="font-size:22px">üéâ</span><span style="color:var(--success)">${text}</span>`;
  } else if(type === 'error'){
    fb.innerHTML = `<span style="font-size:22px">‚ùå</span><span style="color:var(--error)">${text}</span>`;
  } else {
    fb.textContent = text;
  }
}
function clearFeedback(){
  const fb = document.getElementById('feedback');
  fb.className = '';
  fb.textContent = '';
}

/* ---------- CSV download ---------- */
function csvEscape(s){
  if(s === null || s === undefined) return '';
  return '"' + String(s).replace(/"/g,'""') + '"';
}
function downloadCSV(filename, rows){
  const header = ['timestamp','student','sentence','mode','structure','selected','correctLabel','correct','timeTaken_s','streak'];
  const lines = [header.join(',')];
  rows.forEach(r=>{
    lines.push([
      csvEscape(r.timestamp), csvEscape(r.student), csvEscape(r.sentence), csvEscape(r.mode),
      csvEscape(r.structure), csvEscape(r.selected), csvEscape(r.correctLabel), csvEscape(r.correct),
      csvEscape(r.timeTaken), csvEscape(r.streak)
    ].join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
document.getElementById('downloadReport').addEventListener('click', ()=>{
  if(attemptsLog.length === 0){ alert('No hay intentos registrados.'); return; }
  const filename = `${playerName || 'student'}_teacher_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  downloadCSV(filename, attemptsLog);
});

/* ---------- Celebration overlay ---------- */
function showCelebration(){
  const overlay = document.getElementById('celebration');
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
  document.getElementById('celebrationSub').textContent =
    `${playerName || 'Estudiante'} alcanz√≥ ${consecutiveCorrect} aciertos seguidos. ¬°Excelente!`;

  document.getElementById('celebrationDownload').onclick = ()=>{
    if(attemptsLog.length === 0){ alert('No hay intentos registrados.'); return; }
    const filename = `${playerName || 'student'}_teacher_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    downloadCSV(filename, attemptsLog);
  };

  document.getElementById('celebrationRestart').onclick = ()=>{
    overlay.style.display='none';
    consecutiveCorrect = 0;
    score = 0;
    attemptsLog = [];

    document.getElementById('score').textContent = 'Score: 0';
    document.getElementById('streakBox').textContent = 'Streak: 0';
    setProgressPercent(0);

    buildPools();
    nextQuestion();
  };
}

document.getElementById('celebration').addEventListener('click', (e)=>{
  if(e.target === document.getElementById('celebration')){
    document.getElementById('celebration').style.display='none';
  }
});

/* ---------- Init ---------- */
window.addEventListener('load', ()=>{
  buildPools();
  setProgressPercent(0);
  document.getElementById('targetStreak').value = TARGET_STREAK_FIXED;
  document.getElementById('targetLabel').textContent = TARGET_STREAK_FIXED;

  document.getElementById('downloadReport').style.display = 'none';
  document.getElementById('nextBtn').addEventListener('click', nextQuestion);
  document.getElementById('soundToggle').addEventListener('change', (e)=> soundEnabled = e.target.checked);
});
</script>
</body>
</html>
