<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Present Tense Practice ‚Äî Teen Neat (Responsive + Koala Music + Popup Feedback)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#050816;
  --bg2:#0a1740;
  --bg3:#061a2a;

  --panel: rgba(10, 14, 30, .92);

  --ink:#e9f2ff;
  --mut: rgba(233,242,255,.72);

  --ps:#2563eb; --ps2:#1d4ed8;
  --pc:#10b981; --pc2:#0f766e;
  --accent:#a855f7;

  --cardA:#7c3aed; --cardB:#db2777; --cardC:#f59e0b;

  --success:#22c55e;
  --error:#ef4444;
  --warn:#f59e0b;

  --shadow: 0 26px 80px rgba(0,0,0,.55);

  --wordFont: 15px;
  --wordPadY: 10px;
  --wordPadX: 12px;
  --chipMinW: 98px;

  --wMax: 1150px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:Montserrat,system-ui,sans-serif;
  background:
    radial-gradient(900px 520px at 15% 20%, rgba(168,85,247,.26), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(16,185,129,.18), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex; align-items:center; justify-content:center;
  padding:12px;
  color:var(--ink);
}

/* Main container */
.container{
  width:min(var(--wMax), 100%);
  height:calc(100vh - 24px);
  max-height:960px;
  min-height:640px;
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  display:grid;
  grid-template-columns: 1fr 320px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

/* Header */
.header{grid-column:1/2; grid-row:1/2; display:flex; gap:12px; align-items:center}
.logo{
  width:56px;height:56px;border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.16);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 14px 28px rgba(0,0,0,.25);
}
.title{margin:0;font-size:20px;color:#f0e9ff;letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--mut)}

/* Topbar */
.topbar{
  grid-column:1/2; grid-row:2/3;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  gap:10px;
  flex-wrap:wrap;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:rgba(0,0,0,.12);
}
.playerTag{font-size:13px;color:var(--mut)}
.playerTag strong{color:var(--ink)}

/* Controls panel */
.controlsPanel{
  grid-column:2/3; grid-row:1/4;
  display:flex; flex-direction:column; gap:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  overflow:hidden;
}
.inputRow{display:flex;flex-direction:column;gap:6px}
.inputRow label{font-weight:900;font-size:13px;color:var(--ink)}
.inputRow input{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input::placeholder{color:rgba(233,242,255,.55)}
.inputRow input:focus{
  border-color: rgba(168,85,247,.70);
  box-shadow:0 0 0 5px rgba(168,85,247,.18);
}
.lockedHint{font-size:12px;color:var(--mut);margin-top:-4px}
.controlsBtns{display:flex;gap:10px}
.btnPrimary,.btnSecondary{
  width:50%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.btnPrimary{
  border:none;
  color:#fff;
  background:linear-gradient(180deg,var(--accent),#6d28d9);
  box-shadow:0 14px 28px rgba(168,85,247,.20);
}
.btnSecondary{
  border:1px solid rgba(255,255,255,.16);
  color:var(--ink);
  background:rgba(0,0,0,.14);
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.05)}
.toggles{
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:13px;color:var(--mut);
}
.toggles label{display:flex;gap:8px;align-items:center;cursor:pointer;user-select:none}
.tipBox{
  margin-top:auto;
  padding:12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.05);
  font-size:12.5px;
  color:rgba(233,242,255,.80);
  line-height:1.35;
}

/* Game area */
.game{
  grid-column:1/2; grid-row:3/4;
  overflow:hidden;
  display:flex;
  align-items:stretch;
  justify-content:center;
  position:relative;
  min-height:0;
}
.gameInner{
  width:100%;
  max-width:820px;
  height:100%;
  display:grid;
  grid-template-rows:
    minmax(130px, .38fr)
    minmax(54px, auto)
    minmax(210px, 1fr)
    auto
    auto;
  gap:10px;
  overflow:hidden;
  min-height:0;
}

/* FX layer */
#fxLayer{position:absolute; inset:0; pointer-events:none; overflow:hidden}

/* Prompt card */
#card{
  border-radius:18px;
  padding:12px;
  background:linear-gradient(135deg,var(--cardA),var(--cardB),var(--cardC));
  box-shadow:0 18px 48px rgba(0,0,0,.30);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  position:relative;
  overflow:hidden;
}
#card::before{
  content:"";
  position:absolute; inset:-25%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.22), transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,.18), transparent 48%),
    radial-gradient(circle at 70% 75%, rgba(255,255,255,.14), transparent 52%);
  transform:rotate(-10deg);
  pointer-events:none;
  animation: floatGlow 4.2s ease-in-out infinite;
}
@keyframes floatGlow{
  0%,100%{transform:rotate(-10deg) translateY(0)}
  50%{transform:rotate(-10deg) translateY(10px)}
}
#cardLabel{
  position:relative;
  font-size:13px;
  font-weight:900;
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter: blur(8px);
  margin:0 0 8px;
}
#cardText{
  position:relative;
  width:min(92%, 780px);
  padding:10px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 2.05vw, 30px);
  line-height:1.14;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
  overflow-wrap:anywhere;
  word-break:break-word;
}

/* Order box */
#orderBox{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(255,255,255,.06);
  padding:10px;
  min-height:54px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:var(--ink);
  overflow:hidden;
}

/* Options container */
#options{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.14);
  padding:10px;
  overflow:hidden;
  min-height:0;
}

/* Multiple choice mode */
#options.mode-multiple{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  align-content:stretch;
}
.choiceCard{
  border:none;
  border-radius:18px;
  padding:14px 14px;
  color:#fff;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:84px;
  box-shadow:0 16px 34px rgba(0,0,0,.22);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
  position:relative;
  overflow:hidden;
}
.choiceCard::after{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%);
  transform:rotate(10deg);
  opacity:.7;
}
.choiceCard:hover{transform:translateY(-3px);filter:brightness(1.06);box-shadow:0 18px 40px rgba(0,0,0,.30)}
.choiceCard:disabled{opacity:.65;cursor:not-allowed;transform:none !important}
.choiceIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.18);
  font-size:22px;
  z-index:1;
}
.choiceText{z-index:1}
.choiceText small{display:block;font-size:12px;font-weight:800;opacity:.92;margin-top:2px}
.choicePS{background:linear-gradient(135deg,var(--ps),var(--ps2)); box-shadow:0 16px 34px rgba(37,99,235,.20);}
.choicePC{background:linear-gradient(135deg,var(--pc),var(--pc2)); box-shadow:0 16px 34px rgba(16,185,129,.18);}

/* Order mode */
#options.mode-order{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(var(--chipMinW), 1fr));
  gap:12px;
  align-content:start;
  grid-auto-rows: minmax(44px, auto);
}
.orderWord{
  border:none;
  border-radius:16px;
  padding: var(--wordPadY) var(--wordPadX);
  font-weight:900;
  font-size: var(--wordFont);
  cursor:pointer;
  color:var(--ink);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 12px 22px rgba(0,0,0,.18);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
  text-align:center;
  white-space:nowrap;
}
.orderWord:hover{transform:translateY(-3px); filter:brightness(1.06); box-shadow:0 14px 28px rgba(0,0,0,.26);}
.orderWord:disabled{opacity:.55;cursor:not-allowed;transform:none !important}
.orderWord.chosen{
  color:#fff;
  border-color: rgba(239,68,68,.40);
  background:linear-gradient(180deg,#ef4444,#b91c1c);
}

/* Selected chips */
.selChip{
  padding:8px 12px;
  border-radius:14px;
  background:rgba(168,85,247,.20);
  border:1px solid rgba(168,85,247,.30);
  font-weight:900;
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, filter .12s ease;
}
.selChip:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* Progress */
.progressWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#16a34a,#22c55e);
  background-size:200% 100%;
  transition:width 450ms ease;
}
.progressLabel{
  font-size:12px;
  color:var(--mut);
  text-align:center;
  margin-top:-4px;
}

/* Controls row */
.controlsRow{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
}
.smallBtn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease;
}
.smallBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.smallBtn:disabled{opacity:.6;cursor:not-allowed;transform:none !important}

/* Footer */
.footer{
  grid-column:1/2; grid-row:4/5;
  display:flex; justify-content:space-between; align-items:center;
  color:var(--mut); font-size:13px;
  gap:10px; flex-wrap:wrap;
}

/* Celebration overlay */
.celebration-overlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,8,23,0.70);
  z-index:9999;
  padding:18px;
}
.celebration-card{
  width:min(760px, 100%);
  background:linear-gradient(180deg, rgba(10,14,30,.92), rgba(10,14,30,.88));
  border:1px solid rgba(255,255,255,.12);
  color:var(--ink);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.60);
}
.celebration-title{font-size:34px;font-weight:900;color:#f0e9ff;margin-bottom:8px}
.celebration-actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}

/* POPUP FEEDBACK overlay (inside game) */
.fbOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(2,8,23,.62);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  z-index:20;
}
.fbOverlay.show{
  opacity:1;
  pointer-events:auto;
}
.fbCard{
  width:min(620px, 92%);
  border-radius:18px;
  padding:18px 18px 16px;
  background:linear-gradient(180deg, rgba(10,14,30,.96), rgba(10,14,30,.92));
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  text-align:center;
  transform:scale(.965) translateY(6px);
  animation: fbIn .22s ease both;
}
@keyframes fbIn{to{transform:scale(1) translateY(0)}}
.fbTop{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:900}
.fbIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  font-size:22px;
}
.fbTitle{font-size:20px;margin:0}
.fbSub{
  margin:10px auto 0;
  font-size:14px;
  color:rgba(233,242,255,.86);
  font-weight:800;
  line-height:1.3;
  max-width:560px;
}
.fbDetail{
  margin:10px auto 0;
  font-size:13px;
  color:rgba(233,242,255,.72);
  font-weight:800;
  line-height:1.35;
  max-width:560px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:10px;
}
.fbBtnRow{
  margin-top:12px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.fbBtn{
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  transition:transform .12s ease, filter .12s ease;
}
.fbBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.fbBtn.primary{
  border:none;
  background:linear-gradient(180deg,var(--accent),#6d28d9);
  color:#fff;
}

/* Particles */
.p{
  position:absolute;
  width:8px;height:8px;
  border-radius:3px;
  opacity:.95;
  will-change: transform, opacity;
  animation: pFly .55s ease-out forwards;
}
@keyframes pFly{
  0%{transform:translate(0,0) scale(1); opacity:1}
  100%{transform:translate(var(--dx), var(--dy)) scale(.6); opacity:0}
}

/* Responsive */
@media (max-width: 1040px){
  .container{
    grid-template-columns:1fr;
    grid-template-rows:auto auto 1fr auto auto;
    max-height:none;
    height:auto;
    min-height:0;
  }
  .controlsPanel{
    grid-column:1/2; grid-row:5/6;
    flex-direction:row; flex-wrap:wrap; gap:10px;
  }
  .inputRow{width:calc(50% - 5px)}
  .controlsBtns{width:100%}
  .tipBox{width:100%; margin-top:0}
  .game{min-height:520px}
}
@media (max-width: 640px){
  .inputRow{width:100%}
  #options.mode-multiple{grid-template-columns:1fr}
  .game{min-height:560px}
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  #card::before{animation:none !important}
  *{transition:none !important}
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Present tense practice game">
    <!-- Header -->
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#a855f7"/>
              <stop offset="1" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Present Tense Practice</h1>
        <p class="lead">teen mode ‚Ä¢ responsive ‚Ä¢ popup feedback ‚Ä¢ goal: <b>25 in a row</b></p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="score">Score: 0</div>
        <div class="stat" id="timer">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="playerTag">Player: <strong id="playerName">‚Äî</strong></div>
    </div>

    <!-- Controls -->
    <div class="controlsPanel">
      <div class="inputRow">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="E.g., Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Target streak</label>
        <input id="targetStreak" type="number" value="25" disabled>
        <div class="lockedHint">Locked to 25 ‚úÖ</div>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary">START</button>
        <button id="resetBtn" class="btnSecondary">RESET</button>
      </div>

      <div class="toggles">
        <label><input id="soundToggle" type="checkbox" checked> SFX</label>
        <label><input id="musicToggle" type="checkbox" checked> Music</label>
        <label><input id="autoNextToggle" type="checkbox" checked> Auto-next</label>
        <label title="More ordering rounds">
          <input id="moreOrderToggle" type="checkbox"> More order
        </label>
      </div>

      <div class="tipBox">
        <b>How to play</b><br>
        ‚Ä¢ <b>Multiple-choice:</b> choose the tense (PS / PC).<br>
        ‚Ä¢ <b>Order mode:</b> tap words to rebuild the sentence. Tap a chip to undo.<br>
        ‚Ä¢ Popup shows your result + the correct answer.
      </div>
    </div>

    <!-- Game -->
    <div class="game" role="main" aria-live="polite">
      <div id="fxLayer" aria-hidden="true"></div>

      <!-- Popup feedback overlay -->
      <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
        <div class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
          <div class="fbTop">
            <div class="fbIcon" id="fbIcon">‚úÖ</div>
            <h3 class="fbTitle" id="fbTitle">Nice!</h3>
          </div>
          <div class="fbSub" id="fbSub">Keep it going.</div>
          <div class="fbDetail" id="fbDetail"></div>
          <div class="fbBtnRow">
            <button class="fbBtn" id="fbCloseBtn" type="button">Close</button>
            <button class="fbBtn primary" id="fbNextBtn" type="button">Next</button>
          </div>
        </div>
      </div>

      <div class="gameInner">
        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Read and answer</div>
          <div id="cardText">Press START to begin</div>
        </div>

        <div id="orderBox" aria-live="polite">Your selected words will appear here.</div>

        <div id="options" role="group" aria-label="Answer options"></div>

        <div class="progressWrap" aria-hidden="false">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Progress 0%</div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none">Reset order</button>
          <button id="nextBtn" class="smallBtn" style="display:none">Next</button>
          <button id="downloadReport" class="smallBtn" style="display:none">CSV</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div>Bank: Present Simple / Present Continuous ‚Äî 6 categories (20 each)</div>
      <div>Goal: <span id="targetLabel">25</span> in a row</div>
    </div>

    <!-- Celebration -->
    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">GG! üèÜ</div>
        <div id="celebrationSub" style="color:var(--mut);font-weight:900">You hit the target streak.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary" style="width:auto;padding:12px 18px">Download CSV</button>
          <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ koala.mp3 as background music ONLY -->
  <audio id="bgMusic" src="audio/koala.mp3" preload="auto" loop></audio>

<script>
/* =========================================================
   ‚úÖ FIXED BANKS: 6 categories x 20 sentences = 120 total
   ========================================================= */

/* Present Simple ‚Äî Affirmative (20) */
const PS_aff = [
  "She usually walks to school.",
  "He plays the guitar every afternoon.",
  "They enjoy quiet mornings together.",
  "My cat sleeps on my backpack.",
  "I like how this coffee smells.",
  "We read the newspaper every morning.",
  "The bus arrives at eight o'clock.",
  "Tom studies French at university.",
  "Anna works in a small bakery.",
  "Birds fly south in winter.",
  "The shop opens at nine every day.",
  "He drinks green tea after lunch.",
  "Students practice vocabulary every evening.",
  "She always helps her neighbors.",
  "The sun rises in the east.",
  "He writes emails every morning.",
  "We celebrate birthdays with cake.",
  "The teacher explains the lesson clearly.",
  "She takes the dog for a walk daily.",
  "They visit the museum on weekends."
];

/* Present Simple ‚Äî Negative (20) */
const PS_neg = [
  "She doesn't like cold pizza.",
  "They don't study on Sundays.",
  "He does not enjoy long movies.",
  "I don't drink soda anymore.",
  "The cat doesn't sleep in its bed.",
  "We don't watch TV at night.",
  "He doesn't own a car.",
  "She does not eat meat.",
  "They don't arrive early.",
  "I don't understand this word.",
  "She doesn't answer her phone often.",
  "We don't use that old computer anymore.",
  "He doesn't believe the rumor.",
  "They don't accept late homework.",
  "I don't remember his name.",
  "She doesn't drive to work.",
  "He doesn't like loud music.",
  "We don't go out when it rains.",
  "The store doesn't open on Sundays.",
  "He doesn't speak Spanish."
];

/* Present Simple ‚Äî Interrogative (20) */
const PS_int = [
  "Do you like spicy food?",
  "Does she play the violin?",
  "Do they live near here?",
  "Does he enjoy swimming?",
  "Do we have class today?",
  "Do you speak English?",
  "Does it rain a lot here?",
  "Do they know the answer?",
  "Does she work on Saturdays?",
  "Do I need to bring a book?",
  "Do you usually study in the morning?",
  "Does he visit his grandparents every week?",
  "Do they play chess after school?",
  "Does she cook for the family?",
  "Do we meet at the library?",
  "Do you understand the instructions?",
  "Does he take the train to work?",
  "Do they practice every day?",
  "Does she prefer tea or coffee?",
  "Do I have to finish this today?"
];

/* Present Continuous ‚Äî Affirmative (20) */
const PC_aff = [
  "She's studying English right now.",
  "They are cooking dinner together.",
  "He's drawing a robot at the moment.",
  "I'm listening to music.",
  "We're walking to the bus stop.",
  "She is reading a new novel.",
  "They are playing football in the park.",
  "He is fixing his bicycle.",
  "I'm watching a documentary.",
  "We are preparing for the exam.",
  "She is practicing the piano this afternoon.",
  "They are building a model in the workshop.",
  "He is cleaning his room right now.",
  "I'm checking my email at the moment.",
  "We are learning a new song today.",
  "She is talking on the phone now.",
  "They are planting flowers in the garden.",
  "He is carrying a heavy box.",
  "I'm writing a message to my teacher.",
  "We are working on a group project."
];

/* Present Continuous ‚Äî Negative (20) */
const PC_neg = [
  "She isn't studying right now.",
  "They aren't cooking dinner at the moment.",
  "He is not playing video games today.",
  "I'm not watching TV right now.",
  "We aren't going to the mall today.",
  "She isn't wearing her glasses today.",
  "They aren't listening to the teacher.",
  "He isn't doing his homework right now.",
  "I'm not reading that book this week.",
  "We are not waiting for the bus anymore.",
  "She isn't texting during class.",
  "They aren't practicing for the match today.",
  "He isn't working on Friday.",
  "I'm not using my phone right now.",
  "We aren't studying in the library today.",
  "She is not eating lunch at the moment.",
  "They aren't sitting next to each other.",
  "He isn't talking to anyone right now.",
  "I'm not feeling well today.",
  "We aren't planning a trip this month."
];

/* Present Continuous ‚Äî Interrogative (20) */
const PC_int = [
  "Are you studying right now?",
  "Is she playing the piano at the moment?",
  "Are they cooking dinner together?",
  "Is he listening to music?",
  "Are we meeting after school today?",
  "Am I speaking too fast?",
  "Is it raining right now?",
  "Are they working on the project today?",
  "Is she wearing a new jacket?",
  "Are you waiting for someone?",
  "Is he sitting in the front row?",
  "Are we learning this topic today?",
  "Are they practicing for the exam?",
  "Is she talking on the phone now?",
  "Am I doing this correctly?",
  "Is he watching a documentary?",
  "Are we building a model in class?",
  "Are they playing football in the park?",
  "Is she writing an email right now?",
  "Are you feeling okay today?"
];

/* =========================================================
   GAME ENGINE (stable + responsive)
   ========================================================= */

const $ = (id)=>document.getElementById(id);

const els = {
  score: $("score"),
  timer: $("timer"),
  streak: $("streakBox"),
  playerName: $("playerName"),
  studentName: $("studentName"),
  targetLabel: $("targetLabel"),

  startBtn: $("startBtn"),
  resetBtn: $("resetBtn"),

  soundToggle: $("soundToggle"),
  musicToggle: $("musicToggle"),
  autoNextToggle: $("autoNextToggle"),
  moreOrderToggle: $("moreOrderToggle"),

  cardLabel: $("cardLabel"),
  cardText: $("cardText"),
  orderBox: $("orderBox"),
  options: $("options"),

  progressBar: $("progressBar"),
  progressLabel: $("progressLabel"),

  resetOrder: $("resetOrder"),
  nextBtn: $("nextBtn"),
  downloadReport: $("downloadReport"),

  fbOverlay: $("feedbackOverlay"),
  fbIcon: $("fbIcon"),
  fbTitle: $("fbTitle"),
  fbSub: $("fbSub"),
  fbDetail: $("fbDetail"),
  fbCloseBtn: $("fbCloseBtn"),
  fbNextBtn: $("fbNextBtn"),

  celebration: $("celebration"),
  celebrationSub: $("celebrationSub"),
  celebrationDownload: $("celebrationDownload"),
  celebrationRestart: $("celebrationRestart"),

  bgMusic: $("bgMusic"),
  fxLayer: $("fxLayer"),
};

const TARGET_STREAK = 25;

const BANKS = [
  { key:"PS_aff", label:"Present Simple ‚Ä¢ Affirmative", tense:"PS", kind:"aff", items: PS_aff },
  { key:"PS_neg", label:"Present Simple ‚Ä¢ Negative", tense:"PS", kind:"neg", items: PS_neg },
  { key:"PS_int", label:"Present Simple ‚Ä¢ Questions", tense:"PS", kind:"int", items: PS_int },

  { key:"PC_aff", label:"Present Continuous ‚Ä¢ Affirmative", tense:"PC", kind:"aff", items: PC_aff },
  { key:"PC_neg", label:"Present Continuous ‚Ä¢ Negative", tense:"PC", kind:"neg", items: PC_neg },
  { key:"PC_int", label:"Present Continuous ‚Ä¢ Questions", tense:"PC", kind:"int", items: PC_int },
];

function nowISO(){ return new Date().toISOString(); }

const state = {
  running:false,
  startTime:0,
  timerInt:null,

  score:0,
  streak:0,
  rounds:0,

  current:null,     // {bankKey, bankLabel, tense, kind, sentence}
  mode:"multiple",  // "multiple" or "order"
  chosenWords:[],
  wordButtons:[],

  // logging for CSV
  log:[],
};

function safeShuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function cleanSentenceForCompare(s){
  // normalize quotes + spacing; keep punctuation
  return s.replace(/\s+/g," ").trim();
}

function sentenceToTokens(sentence){
  // Keep punctuation attached to words for simpler matching
  // Example: "today?" stays on token "today?"
  return sentence.trim().split(/\s+/);
}

function chooseNextRound(){
  const bank = BANKS[Math.floor(Math.random()*BANKS.length)];
  const sentence = bank.items[Math.floor(Math.random()*bank.items.length)];
  state.current = { bankKey: bank.key, bankLabel: bank.label, tense: bank.tense, kind: bank.kind, sentence };

  // mode choice: default mixed (mostly multiple), optionally more order
  const orderChance = els.moreOrderToggle.checked ? 0.55 : 0.30;
  const canOrder = true; // allow order for ALL (including questions) because punctuation stays on last token
  state.mode = (canOrder && Math.random() < orderChance) ? "order" : "multiple";

  state.chosenWords = [];
  state.wordButtons = [];
}

function setPlayerName(){
  const name = (els.studentName.value || "").trim();
  els.playerName.textContent = name ? name : "‚Äî";
}

function setStats(){
  els.score.textContent = `Score: ${state.score}`;
  els.streak.textContent = `Streak: ${state.streak}`;
  const pct = Math.round(Math.min(100, (state.streak / TARGET_STREAK) * 100));
  els.progressBar.style.width = `${pct}%`;
  els.progressLabel.textContent = `Progress ${pct}%`;
  els.targetLabel.textContent = String(TARGET_STREAK);

  // show CSV button after a few rounds
  els.downloadReport.style.display = state.log.length ? "inline-block" : "none";
}

function startTimer(){
  state.startTime = Date.now();
  if(state.timerInt) clearInterval(state.timerInt);
  state.timerInt = setInterval(()=>{
    const secs = Math.floor((Date.now() - state.startTime)/1000);
    els.timer.textContent = `Time: ${secs}s`;
  }, 250);
}

function stopTimer(){
  if(state.timerInt) clearInterval(state.timerInt);
  state.timerInt = null;
}

function resetUIToIdle(){
  els.cardLabel.textContent = "Read and answer";
  els.cardText.textContent = "Press START to begin";
  els.orderBox.textContent = "Your selected words will appear here.";
  els.options.className = "";
  els.options.innerHTML = "";
  els.resetOrder.style.display = "none";
  els.nextBtn.style.display = "none";
  hidePopup();
  hideCelebration();
}

function popParticles(ok){
  if(!els.soundToggle.checked) return;
  const n = ok ? 22 : 14;
  for(let i=0;i<n;i++){
    const p = document.createElement("div");
    p.className = "p";
    const x = Math.random()*100;
    const y = Math.random()*100;
    p.style.left = `${x}%`;
    p.style.top = `${y}%`;
    const dx = (Math.random()*240 - 120) + "px";
    const dy = (Math.random()*240 - 120) + "px";
    p.style.setProperty("--dx", dx);
    p.style.setProperty("--dy", dy);
    p.style.background = ok
      ? (Math.random() < 0.5 ? "#22c55e" : "#10b981")
      : (Math.random() < 0.5 ? "#ef4444" : "#f59e0b");
    els.fxLayer.appendChild(p);
    setTimeout(()=>p.remove(), 650);
  }
}

function showPopup({ok, title, sub, detail}){
  els.fbOverlay.classList.add("show");
  els.fbOverlay.setAttribute("aria-hidden","false");
  els.fbIcon.textContent = ok ? "‚úÖ" : "‚ùå";
  els.fbTitle.textContent = title;
  els.fbSub.textContent = sub;
  els.fbDetail.textContent = detail || "";
  els.fbNextBtn.style.display = "inline-block";
}

function hidePopup(){
  els.fbOverlay.classList.remove("show");
  els.fbOverlay.setAttribute("aria-hidden","true");
}

function showCelebration(){
  els.celebration.style.display = "flex";
  els.celebration.setAttribute("aria-hidden","false");
  const secs = Math.floor((Date.now() - state.startTime)/1000);
  els.celebrationSub.textContent = `You hit ${TARGET_STREAK} in a row in ${secs}s. üî•`;
}

function hideCelebration(){
  els.celebration.style.display = "none";
  els.celebration.setAttribute("aria-hidden","true");
}

function logAttempt({mode, bankKey, bankLabel, tense, sentence, response, correct}){
  state.log.push({
    time: nowISO(),
    player: (els.studentName.value || "").trim(),
    mode,
    bankKey,
    bankLabel,
    tense,
    sentence,
    response,
    correct: correct ? "1" : "0",
    streakAfter: String(state.streak),
    scoreAfter: String(state.score),
  });
}

function downloadCSV(){
  const header = [
    "time","player","mode","bankKey","bankLabel","tense","sentence","response","correct","streakAfter","scoreAfter"
  ];
  const lines = [header.join(",")];

  for(const row of state.log){
    const vals = header.map(k=>{
      const v = String(row[k] ?? "");
      // CSV escape
      const safe = v.replaceAll('"','""');
      return `"${safe}"`;
    });
    lines.push(vals.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "present-tense-practice-report.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------------------- RENDER ---------------------- */

function renderRound(){
  const c = state.current;
  if(!c) return;

  els.cardLabel.textContent = state.mode === "multiple"
    ? "Choose the tense"
    : "Rebuild the sentence";

  els.cardText.textContent = c.sentence;

  if(state.mode === "multiple"){
    renderMultiple();
  }else{
    renderOrder();
  }

  setStats();
}

function renderMultiple(){
  els.options.className = "mode-multiple";
  els.resetOrder.style.display = "none";
  els.nextBtn.style.display = "none";
  els.orderBox.textContent = "Order mode is off for this round.";

  const btnPS = document.createElement("button");
  btnPS.className = "choiceCard choicePS";
  btnPS.innerHTML = `
    <div class="choiceIcon">üìò</div>
    <div class="choiceText">
      Present Simple
      <small>habits ‚Ä¢ facts ‚Ä¢ routines</small>
    </div>
  `;

  const btnPC = document.createElement("button");
  btnPC.className = "choiceCard choicePC";
  btnPC.innerHTML = `
    <div class="choiceIcon">‚ö°</div>
    <div class="choiceText">
      Present Continuous
      <small>now ‚Ä¢ temporary ‚Ä¢ happening</small>
    </div>
  `;

  els.options.innerHTML = "";
  els.options.appendChild(btnPS);
  els.options.appendChild(btnPC);

  btnPS.addEventListener("click", ()=> submitMultiple("PS"));
  btnPC.addEventListener("click", ()=> submitMultiple("PC"));
}

function submitMultiple(choice){
  const c = state.current;
  if(!c || !state.running) return;

  const correct = (choice === c.tense);
  handleResult({
    mode:"multiple",
    response: choice === "PS" ? "Present Simple" : "Present Continuous",
    correct,
    correctAnswer: c.tense === "PS" ? "Present Simple" : "Present Continuous",
  });
}

function renderOrder(){
  els.options.className = "mode-order";
  els.orderBox.innerHTML = "";
  els.resetOrder.style.display = "inline-block";
  els.nextBtn.style.display = "none";

  const tokens = sentenceToTokens(state.current.sentence);
  const shuffled = safeShuffle(tokens);

  state.chosenWords = [];
  els.orderBox.textContent = "Tap words below to build the sentence.";

  els.options.innerHTML = "";
  state.wordButtons = shuffled.map((tok, idx)=>{
    const b = document.createElement("button");
    b.className = "orderWord";
    b.type = "button";
    b.textContent = tok;
    b.addEventListener("click", ()=> pickWord(b, tok));
    els.options.appendChild(b);
    return b;
  });
}

function pickWord(btn, tok){
  if(btn.disabled || !state.running) return;
  btn.disabled = true;
  btn.classList.add("chosen");

  state.chosenWords.push(tok);
  drawChosenChips();

  // if finished, auto-check
  const total = sentenceToTokens(state.current.sentence).length;
  if(state.chosenWords.length === total){
    checkOrder();
  }
}

function drawChosenChips(){
  els.orderBox.innerHTML = "";
  if(state.chosenWords.length === 0){
    els.orderBox.textContent = "Tap words below to build the sentence.";
    return;
  }
  state.chosenWords.forEach((w, i)=>{
    const chip = document.createElement("span");
    chip.className = "selChip";
    chip.textContent = w;
    chip.title = "Tap to undo from here";
    chip.addEventListener("click", ()=> undoToIndex(i));
    els.orderBox.appendChild(chip);
  });
}

function undoToIndex(i){
  // undo from i to end
  if(!state.running) return;
  const undone = state.chosenWords.splice(i);
  // re-enable corresponding buttons
  for(const tok of undone){
    const btn = state.wordButtons.find(b=>b.textContent===tok && b.disabled);
    // above might match the wrong duplicate token; handle duplicates by enabling first match
    if(btn){
      btn.disabled = false;
      btn.classList.remove("chosen");
    }else{
      // fallback: enable any disabled with same text
      const any = state.wordButtons.find(b=>b.textContent===tok && b.disabled);
      if(any){
        any.disabled = false;
        any.classList.remove("chosen");
      }
    }
  }
  drawChosenChips();
}

function resetOrder(){
  if(!state.running) return;
  state.chosenWords = [];
  // re-enable all
  state.wordButtons.forEach(b=>{
    b.disabled = false;
    b.classList.remove("chosen");
  });
  drawChosenChips();
}

function checkOrder(){
  const target = cleanSentenceForCompare(state.current.sentence);
  const built = cleanSentenceForCompare(state.chosenWords.join(" "));
  const correct = (built === target);

  handleResult({
    mode:"order",
    response: built,
    correct,
    correctAnswer: target
  });
}

/* ---------------------- RESULT HANDLING ---------------------- */

function handleResult({mode, response, correct, correctAnswer}){
  const c = state.current;

  // scoring
  state.rounds++;
  if(correct){
    state.score += 10;
    state.streak += 1;
  }else{
    state.score = Math.max(0, state.score - 2);
    state.streak = 0;
  }

  setStats();
  popParticles(correct);

  logAttempt({
    mode,
    bankKey: c.bankKey,
    bankLabel: c.bankLabel,
    tense: c.tense,
    sentence: c.sentence,
    response,
    correct,
  });

  // disable inputs until next
  disableRoundInputs();

  // popup message
  const title = correct ? "Nice! ‚úÖ" : "Not this time ‚ùå";
  const sub = correct
    ? `Correct ‚Äî ${c.bankLabel}`
    : `Correct answer: ${c.tense === "PS" ? "Present Simple" : "Present Continuous"}`;

  const detail = mode === "multiple"
    ? `You chose: ${response}\nSentence: ${c.sentence}`
    : `Your order: ${response}\nCorrect: ${correctAnswer}`;

  showPopup({
    ok: correct,
    title,
    sub,
    detail,
  });

  // show next button
  els.nextBtn.style.display = "inline-block";
  els.nextBtn.disabled = false;

  // win condition
  if(state.streak >= TARGET_STREAK){
    showCelebration();
  }

  // auto-next (if not won yet)
  if(els.autoNextToggle.checked && state.streak < TARGET_STREAK){
    setTimeout(()=> {
      if(els.fbOverlay.classList.contains("show")) goNext();
    }, 900);
  }
}

function disableRoundInputs(){
  // disable all choice cards / word buttons
  els.options.querySelectorAll("button").forEach(b=>b.disabled = true);
  els.resetOrder.disabled = true;
}

function enableRoundInputs(){
  els.resetOrder.disabled = false;
}

/* ---------------------- FLOW ---------------------- */

function goNext(){
  hidePopup();
  if(state.streak >= TARGET_STREAK){
    // keep celebration until restart
    return;
  }
  chooseNextRound();
  renderRound();
  enableRoundInputs();
  els.resetOrder.style.display = (state.mode==="order") ? "inline-block" : "none";
}

function startGame(){
  setPlayerName();

  state.running = true;
  state.score = 0;
  state.streak = 0;
  state.rounds = 0;
  state.log = [];

  setStats();
  startTimer();

  // music
  if(els.musicToggle.checked){
    els.bgMusic.volume = 0.25;
    // browsers require a user gesture (START click is a gesture)
    els.bgMusic.play().catch(()=>{});
  }

  chooseNextRound();
  renderRound();
  enableRoundInputs();

  els.downloadReport.style.display = "none";
}

function resetGame(){
  state.running = false;
  stopTimer();

  state.score = 0;
  state.streak = 0;
  state.rounds = 0;
  state.current = null;
  state.mode = "multiple";
  state.chosenWords = [];
  state.wordButtons = [];
  state.log = [];

  els.bgMusic.pause();
  els.bgMusic.currentTime = 0;

  els.timer.textContent = "Time: 0s";
  setStats();
  resetUIToIdle();

  // restore buttons
  els.resetOrder.disabled = false;
  els.nextBtn.disabled = false;
  els.downloadReport.style.display = "none";
}

/* ---------------------- EVENTS ---------------------- */

els.studentName.addEventListener("input", setPlayerName);

els.startBtn.addEventListener("click", ()=> {
  // if already running, just ignore
  if(state.running) return;
  startGame();
});

els.resetBtn.addEventListener("click", ()=> resetGame());

els.resetOrder.addEventListener("click", ()=> resetOrder());

els.nextBtn.addEventListener("click", ()=> goNext());

els.downloadReport.addEventListener("click", ()=> downloadCSV());

els.celebrationDownload.addEventListener("click", ()=> downloadCSV());
els.celebrationRestart.addEventListener("click", ()=> {
  hideCelebration();
  resetGame();
  startGame();
});

els.musicToggle.addEventListener("change", ()=>{
  if(!state.running) return;
  if(els.musicToggle.checked){
    els.bgMusic.volume = 0.25;
    els.bgMusic.play().catch(()=>{});
  }else{
    els.bgMusic.pause();
  }
});

// popup buttons
els.fbCloseBtn.addEventListener("click", ()=> hidePopup());
els.fbNextBtn.addEventListener("click", ()=> goNext());

// close popup by clicking outside card
els.fbOverlay.addEventListener("click", (e)=>{
  if(e.target === els.fbOverlay) hidePopup();
});

// keyboard: Enter = next (when popup open)
document.addEventListener("keydown", (e)=>{
  if(!state.running) return;
  if(els.fbOverlay.classList.contains("show")){
    if(e.key === "Enter"){
      e.preventDefault();
      goNext();
    }else if(e.key === "Escape"){
      e.preventDefault();
      hidePopup();
    }
  }
});

// initial
setStats();
resetUIToIdle();
</script>
</body>
</html>

