<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Present Tense Practice ‚Äî Teen Neat (No Scroll + Koala Music + Popup Feedback)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#050816;
  --bg2:#0a1740;
  --bg3:#061a2a;

  --panel: rgba(10, 14, 30, .92);

  --ink:#e9f2ff;
  --mut: rgba(233,242,255,.72);

  --ps:#2563eb; --ps2:#1d4ed8;
  --pc:#10b981; --pc2:#0f766e;
  --accent:#a855f7;

  --cardA:#7c3aed; --cardB:#db2777; --cardC:#f59e0b;

  --success:#22c55e;
  --error:#ef4444;
  --warn:#f59e0b;

  --shadow: 0 26px 80px rgba(0,0,0,.55);

  --wordFont: 16px;
  --wordPadY: 11px;
  --wordPadX: 12px;
  --chipMinW: 110px;

  --wMax: 1150px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:Montserrat,system-ui,sans-serif;
  background:
    radial-gradient(900px 520px at 15% 20%, rgba(168,85,247,.26), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(16,185,129,.18), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex; align-items:center; justify-content:center;
  padding:12px;
  color:var(--ink);
  overflow:hidden; /* global no-scroll */
}

/* NO SCROLL container */
.container{
  width:min(var(--wMax), 100%);
  height:calc(100vh - 24px);
  max-height:920px;
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  display:grid;
  grid-template-columns: 1fr 300px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

/* Header */
.header{grid-column:1/2;grid-row:1/2;display:flex;gap:12px;align-items:center}
.logo{
  width:56px;height:56px;border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.16);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 14px 28px rgba(0,0,0,.25);
}
.title{margin:0;font-size:20px;color:#f0e9ff;letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--mut)}

/* Topbar */
.topbar{
  grid-column:1/2;grid-row:2/3;
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  gap:10px;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:rgba(0,0,0,.12);
}
.playerTag{font-size:13px;color:var(--mut)}
.playerTag strong{color:var(--ink)}

/* Controls */
.controlsPanel{
  grid-column:2/3; grid-row:1/4;
  display:flex; flex-direction:column; gap:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  overflow:hidden;
  min-width: 240px;
}
.inputRow{display:flex;flex-direction:column;gap:6px}
.inputRow label{font-weight:900;font-size:13px;color:var(--ink)}
.inputRow input{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input::placeholder{color:rgba(233,242,255,.55)}
.inputRow input:focus{
  border-color: rgba(168,85,247,.70);
  box-shadow:0 0 0 5px rgba(168,85,247,.18);
}
.lockedHint{font-size:12px;color:var(--mut);margin-top:-4px}
.controlsBtns{display:flex;gap:10px}
.btnPrimary,.btnSecondary{
  width:50%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.btnPrimary{
  border:none;
  color:#fff;
  background:linear-gradient(180deg,var(--accent),#6d28d9);
  box-shadow:0 14px 28px rgba(168,85,247,.20);
}
.btnSecondary{
  border:1px solid rgba(255,255,255,.16);
  color:var(--ink);
  background:rgba(0,0,0,.14);
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.05)}
.btnPrimary:disabled,.btnSecondary:disabled{opacity:.55;cursor:not-allowed;transform:none}

.toggles{
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:13px;color:var(--mut);
}
.toggles label{display:flex;gap:8px;align-items:center;cursor:pointer;user-select:none}
.tipBox{
  margin-top:auto;
  padding:12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.05);
  font-size:12.5px;
  color:rgba(233,242,255,.80);
  line-height:1.35;
}

/* Game */
.game{
  grid-column:1/2; grid-row:3/4;
  overflow:hidden;
  display:flex;
  align-items:stretch;
  justify-content:center;
  position:relative;
}
.gameInner{
  width:100%;
  max-width:820px;
  height:100%;
  display:grid;
  grid-template-rows:
    minmax(120px, .38fr)
    minmax(54px, auto)
    minmax(210px, 1fr)
    auto
    auto;
  gap:10px;
  overflow:hidden;
}

/* FX layer */
#fxLayer{position:absolute; inset:0; pointer-events:none; overflow:hidden}

/* Card */
#card{
  border-radius:18px;
  padding:12px;
  background:linear-gradient(135deg,var(--cardA),var(--cardB),var(--cardC));
  box-shadow:0 18px 48px rgba(0,0,0,.30);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  position:relative;
  overflow:hidden;
}
#card::before{
  content:"";
  position:absolute; inset:-25%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.22), transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,.18), transparent 48%),
    radial-gradient(circle at 70% 75%, rgba(255,255,255,.14), transparent 52%);
  transform:rotate(-10deg);
  pointer-events:none;
  animation: floatGlow 4.2s ease-in-out infinite;
}
@keyframes floatGlow{
  0%,100%{transform:rotate(-10deg) translateY(0)}
  50%{transform:rotate(-10deg) translateY(10px)}
}
#cardLabel{
  position:relative;
  font-size:13px;
  font-weight:900;
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter: blur(8px);
  margin:0 0 8px;
}
#cardText{
  position:relative;
  width:min(92%, 760px);
  padding:10px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 2.0vw, 28px);
  line-height:1.18;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
  overflow-wrap:anywhere;
  word-break:break-word;
}

/* Order box */
#orderBox{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(255,255,255,.06);
  padding:10px;
  min-height:54px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:var(--ink);
  overflow:hidden;
}

/* Options */
#options{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.14);
  padding:10px;
  overflow:auto; /* allow internal scroll if needed on small screens */
}

/* Multiple */
#options.mode-multiple{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  align-content:stretch;
}
.choiceCard{
  border:none;
  border-radius:18px;
  padding:14px 14px;
  color:#fff;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:84px;
  box-shadow:0 16px 34px rgba(0,0,0,.22);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
  position:relative;
  overflow:hidden;
}
.choiceCard::after{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%);
  transform:rotate(10deg);
  opacity:.7;
}
.choiceCard:hover{transform:translateY(-3px);filter:brightness(1.06);box-shadow:0 18px 40px rgba(0,0,0,.30)}
.choiceCard:disabled{opacity:.65;cursor:not-allowed;transform:none !important}
.choiceIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.18);
  font-size:22px;
  z-index:1;
}
.choiceText{z-index:1}
.choiceText small{display:block;font-size:12px;font-weight:800;opacity:.92;margin-top:2px}
.choicePS{background:linear-gradient(135deg,var(--ps),var(--ps2)); box-shadow:0 16px 34px rgba(37,99,235,.20);}
.choicePC{background:linear-gradient(135deg,var(--pc),var(--pc2)); box-shadow:0 16px 34px rgba(16,185,129,.18);}

/* Order mode */
#options.mode-order{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(var(--chipMinW), 1fr));
  gap:12px;
  align-content:start;
  grid-auto-rows: minmax(44px, auto);
}
.orderWord{
  border:none;
  border-radius:16px;
  padding: var(--wordPadY) var(--wordPadX);
  font-weight:900;
  font-size: var(--wordFont);
  cursor:pointer;
  color:var(--ink);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 12px 22px rgba(0,0,0,.18);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
  text-align:center;
  white-space:nowrap;
}
.orderWord:hover{transform:translateY(-3px); filter:brightness(1.06); box-shadow:0 14px 28px rgba(0,0,0,.26);}
.orderWord:disabled{opacity:.55;cursor:not-allowed;transform:none !important}

/* Selected chips */
.selChip{
  padding:9px 12px;
  border-radius:14px;
  background:rgba(168,85,247,.22);
  border:1px solid rgba(168,85,247,.35);
  font-weight:900;
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, filter .12s ease;
}
.selChip:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* Progress */
.progressWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#16a34a,#22c55e);
  background-size:200% 100%;
  transition:width 600ms ease;
}
.progressBar.moving{ animation: prog 1.1s linear infinite; }
@keyframes prog{ 0%{background-position:0%} 100%{background-position:200%} }
.progressLabel{
  font-size:12px;
  color:var(--mut);
  text-align:center;
  margin-top:-4px;
}

/* Controls row under the game */
.controlsRow{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
}
.smallBtn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:11px 16px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease;
}
.smallBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.smallBtn:disabled{opacity:.6;cursor:not-allowed;transform:none !important}

/* Footer */
.footer{
  grid-column:1/2; grid-row:4/5;
  display:flex; justify-content:space-between; align-items:center;
  color:var(--mut); font-size:13px;
  gap:12px;
}

/* Celebration overlay */
.celebration-overlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,8,23,0.70);
  z-index:9999;
  padding:18px;
}
.celebration-card{
  width:min(760px, 100%);
  background:linear-gradient(180deg, rgba(10,14,30,.92), rgba(10,14,30,.88));
  border:1px solid rgba(255,255,255,.12);
  color:var(--ink);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.60);
}
.celebration-title{font-size:34px;font-weight:900;color:#f0e9ff;margin-bottom:8px}
.celebration-actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}

/* POPUP FEEDBACK overlay (inside game) */
.fbOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(2,8,23,.62);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  z-index:20;
}
.fbOverlay.show{opacity:1;pointer-events:auto}
.fbCard{
  width:min(720px, 94%);
  border-radius:18px;
  padding:20px 18px 16px;
  background:linear-gradient(180deg, rgba(10,14,30,.98), rgba(10,14,30,.92));
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  text-align:center;
  transform:scale(.965) translateY(6px);
  animation: fbIn .22s ease both;
}
@keyframes fbIn{to{transform:scale(1) translateY(0)}}

.fbCard.success{
  border-color: rgba(34,197,94,.45);
  box-shadow:0 24px 80px rgba(34,197,94,.14), 0 24px 70px rgba(0,0,0,.60);
}
.fbCard.error{
  border-color: rgba(239,68,68,.45);
  box-shadow:0 24px 80px rgba(239,68,68,.14), 0 24px 70px rgba(0,0,0,.60);
}

.fbTop{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-weight:900;
  flex-wrap:wrap;
}
.fbIcon{
  width:52px;height:52px;
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  font-size:26px;
}
.fbTitle{
  font-size:28px; /* BIGGER */
  margin:0;
  letter-spacing:.2px;
}
.fbSub{
  margin:12px auto 0;
  font-size:20px; /* BIGGER */
  font-weight:900;
  line-height:1.35;
  max-width:620px;
  color:#eaf2ff;
}
.fbSub.good{ color: var(--success); }
.fbSub.bad{ color: var(--error); }

.fbDetail{
  margin:12px auto 0;
  font-size:18px;  /* BIGGER */
  color:#f8fafc;
  font-weight:800;
  line-height:1.45;
  max-width:640px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:12px;
}

.fbBtnRow{
  margin-top:14px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.fbBtn{
  border-radius:14px;
  padding:11px 16px;
  font-weight:900;
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  transition:transform .12s ease, filter .12s ease;
}
.fbBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.fbBtn.primary{
  border:none;
  background:linear-gradient(180deg,var(--accent),#6d28d9);
  color:#fff;
}

/* Particle */
.p{
  position:absolute;
  width:8px;height:8px;
  border-radius:3px;
  opacity:.95;
  will-change: transform, opacity;
  animation: pFly .55s ease-out forwards;
}
@keyframes pFly{
  0%{transform:translate(0,0) scale(1); opacity:1}
  100%{transform:translate(var(--dx), var(--dy)) scale(.6); opacity:0}
}

/* Responsive */
@media (max-height: 760px){
  .container{padding:12px; gap:10px}
  .gameInner{gap:8px; grid-template-rows:minmax(110px,.36fr) minmax(48px,auto) minmax(190px,1fr) auto auto;}
  #cardText{font-size:clamp(17px, 1.9vw, 24px)}
}
@media (max-width: 980px){
  body{overflow:auto} /* allow page scroll on tiny devices; game still self-contained */
  .container{
    grid-template-columns:1fr;
    grid-template-rows:auto auto 1fr auto auto;
    height:auto;
    max-height:none;
    overflow:visible;
  }
  .controlsPanel{
    grid-column:1/2; grid-row:5/6;
    flex-direction:row; flex-wrap:wrap; gap:10px;
  }
  .inputRow{width:calc(50% - 5px)}
  .controlsBtns{width:100%}
  .tipBox{width:100%; margin-top:0}
  .game{grid-row:3/4}
}
@media (max-width: 640px){
  .inputRow{width:100%}
  #options.mode-multiple{grid-template-columns:1fr}
  .fbTitle{font-size:24px}
  .fbSub{font-size:18px}
  .fbDetail{font-size:16px}
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .progressBar.moving,#card::before{animation:none !important}
  *{transition:none !important}
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Present tense practice game">
    <!-- Header -->
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#a855f7"/>
              <stop offset="1" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Present Tense Practice</h1>
        <p class="lead">teen mode ‚Ä¢ no scroll ‚Ä¢ popup feedback ‚Ä¢ goal: <b>25 in a row</b></p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="score">Score: 0</div>
        <div class="stat" id="timer">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="playerTag">Player: <strong id="playerName">‚Äî</strong></div>
    </div>

    <!-- Controls -->
    <div class="controlsPanel">
      <div class="inputRow">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="E.g., Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Target streak</label>
        <input id="targetStreak" type="number" value="25" disabled>
        <div class="lockedHint">Locked to 25 ‚úÖ</div>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary">START</button>
        <button id="resetBtn" class="btnSecondary">RESET</button>
      </div>

      <div class="toggles">
        <label><input id="soundToggle" type="checkbox" checked> SFX</label>
        <label><input id="musicToggle" type="checkbox" checked> Music</label>
        <label><input id="autoNextToggle" type="checkbox" checked> Auto-next</label>
      </div>

      <div class="tipBox">
        <b>How to play</b><br>
        ‚Ä¢ Choose the tense card (Present Simple / Present Continuous).<br>
        ‚Ä¢ Or: build the sentence by tapping words.<br>
        ‚Ä¢ Tap a chip to undo it.<br>
        ‚Ä¢ Popup shows result + correct answer (only after you check).
      </div>
    </div>

    <!-- Game -->
    <div class="game" role="main" aria-live="polite">
      <div id="fxLayer" aria-hidden="true"></div>

      <!-- Popup feedback overlay -->
      <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
        <div id="fbCard" class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
          <div class="fbTop">
            <div class="fbIcon" id="fbIcon">‚úÖ</div>
            <h3 class="fbTitle" id="fbTitle">Nice!</h3>
          </div>
          <div class="fbSub good" id="fbSub">Keep it going.</div>
          <div class="fbDetail" id="fbDetail"></div>
          <div class="fbBtnRow">
            <button class="fbBtn" id="fbCloseBtn" type="button">Close</button>
            <button class="fbBtn primary" id="fbNextBtn" type="button">Next</button>
          </div>
        </div>
      </div>

      <div class="gameInner">
        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Read and answer</div>
          <div id="cardText">Press START to begin</div>
        </div>

        <div id="orderBox" aria-live="polite">Your selected words will appear here.</div>

        <div id="options" role="group" aria-label="Answer options"></div>

        <div class="progressWrap" aria-hidden="false">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Progress 0%</div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none">Reset order</button>
          <button id="checkOrder" class="smallBtn" style="display:none">Check</button>
          <button id="nextBtn" class="smallBtn" style="display:none">Next</button>
          <button id="downloadReport" class="smallBtn" style="display:none">CSV</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div>Bank: Present Simple / Present Continuous ‚Äî 6 categories</div>
      <div>Goal: <span id="targetLabel">25</span> in a row</div>
    </div>

    <!-- Celebration -->
    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">GG! üèÜ</div>
        <div id="celebrationSub" style="color:var(--mut);font-weight:900">You hit the target streak.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary" style="width:auto;padding:12px 18px">Download CSV</button>
          <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- koala.mp3 as background music ONLY -->
  <audio id="bgMusic" src="audio/koala.mp3" preload="auto" loop></audio>

<script>
/* =========================================================
   SENTENCE BANKS ‚Äî 6 categories x 20 (interrogatives include ?)
   ========================================================= */
const PS_aff = [
  "She usually walks to school.",
  "He plays the guitar every afternoon.",
  "They enjoy quiet mornings together.",
  "My cat sleeps on my backpack.",
  "I like how this coffee smells.",
  "We read the newspaper every morning.",
  "The bus arrives at eight o'clock.",
  "Tom studies French at university.",
  "Anna works in a small bakery.",
  "Birds fly south in winter.",
  "The shop opens at nine every day.",
  "He drinks green tea after lunch.",
  "Students practice vocabulary every evening.",
  "She always helps her neighbors.",
  "The sun rises in the east.",
  "He writes emails every morning.",
  "We celebrate birthdays with cake.",
  "The teacher explains the lesson clearly.",
  "She takes the dog for a walk daily.",
  "They visit the museum on weekends."
];

const PS_neg = [
  "She doesn't like cold pizza.",
  "They don't study on Sundays.",
  "He does not enjoy long movies.",
  "I don't drink soda anymore.",
  "The cat doesn't sleep in its bed.",
  "We don't watch TV at night.",
  "He doesn't own a car.",
  "She does not eat meat.",
  "They don't arrive early.",
  "I don't understand this word.",
  "She doesn't answer her phone often.",
  "We don't use that old computer anymore.",
  "He doesn't believe the rumor.",
  "They don't accept late homework.",
  "I don't remember his name.",
  "She doesn't drive to work.",
  "He doesn't like loud music.",
  "We don't go out when it rains.",
  "The store doesn't open on Sundays.",
  "He doesn't speak Spanish."
];

const PS_int = [
  "Do you like spicy food?",
  "Does she play the violin?",
  "Do they live near here?",
  "Does he enjoy swimming?",
  "Do we have class today?",
  "Do you speak English?",
  "Does it rain a lot here?",
  "Do they know the answer?",
  "Does she work on Saturdays?",
  "Do I need to bring a book?",
  "Do you usually study in the morning?",
  "Does he visit his grandparents every week?",
  "Do they play chess after school?",
  "Does she cook for the family?",
  "Do we meet at the library?",
  "Do you understand the instructions?",
  "Does he take the train to work?",
  "Do they practice every day?",
  "Does she prefer tea or coffee?",
  "Do I have to finish this today?"
];

const PC_aff = [
  "She's studying English right now.",
  "They are cooking dinner together.",
  "He's drawing a robot at the moment.",
  "I'm listening to music.",
  "We're walking to the bus stop.",
  "She is reading a new novel.",
  "They are playing football in the park.",
  "He is fixing his bicycle.",
  "I'm watching a documentary.",
  "We are preparing for the exam.",
  "She is practicing the piano this afternoon.",
  "They are building a model in the workshop.",
  "He is cleaning his room right now.",
  "I'm checking my email at the moment.",
  "We are learning a new song today.",
  "She is talking on the phone now.",
  "They are planting flowers in the garden.",
  "He is writing a message to his friend.",
  "I'm waiting for the teacher.",
  "We are working on a group project."
];

const PC_neg = [
  "She isn't studying for the test right now.",
  "They aren't watching TV at the moment.",
  "He isn't playing video games today.",
  "I'm not using my phone in class.",
  "We aren't going to the mall today.",
  "She isn't sleeping right now.",
  "They aren't eating breakfast at the moment.",
  "He isn't talking during the lesson.",
  "I'm not rushing; I'm taking my time.",
  "We aren't arguing today.",
  "She isn't sitting next to me right now.",
  "They aren't doing their homework at the moment.",
  "He isn't listening to the instructions.",
  "I'm not feeling well today.",
  "We aren't working late tonight.",
  "She isn't wearing her jacket right now.",
  "They aren't driving; they are walking.",
  "He isn't making a sandwich at the moment.",
  "I'm not forgetting your message.",
  "We aren't studying in the library today."
];

const PC_int = [
  "Are you studying right now?",
  "Is she talking to the teacher?",
  "Are they playing outside?",
  "Is he working on the project?",
  "Are we leaving soon?",
  "Are you listening carefully?",
  "Is it raining right now?",
  "Are they making a video?",
  "Is she sitting in the front row?",
  "Am I speaking too fast?",
  "Are you wearing your headphones?",
  "Is he cooking dinner tonight?",
  "Are they practicing for the match?",
  "Is she reading that article now?",
  "Are we learning this today?",
  "Are you writing notes at the moment?",
  "Is he using the computer right now?",
  "Are they waiting for the bus?",
  "Is she watching a movie now?",
  "Are we working together today?"
];

/* =========================================================
   GAME CONTENT: 6 categories; each round picks one sentence.
   Mode types:
     - "mc": choose tense label (PS vs PC)
     - "order": build the sentence word-by-word (NO sentence shown first!)
   ========================================================= */

const BANKS = [
  { id:"PS_aff", name:"Present Simple ‚Äî Affirmative", tense:"PS", list: PS_aff },
  { id:"PS_neg", name:"Present Simple ‚Äî Negative",     tense:"PS", list: PS_neg },
  { id:"PS_int", name:"Present Simple ‚Äî Interrogative",tense:"PS", list: PS_int },
  { id:"PC_aff", name:"Present Continuous ‚Äî Affirmative",tense:"PC", list: PC_aff },
  { id:"PC_neg", name:"Present Continuous ‚Äî Negative",    tense:"PC", list: PC_neg },
  { id:"PC_int", name:"Present Continuous ‚Äî Interrogative",tense:"PC", list: PC_int },
];

/* =========================================================
   STATE + UI refs
   ========================================================= */
const elScore = document.getElementById("score");
const elTimer = document.getElementById("timer");
const elStreak = document.getElementById("streakBox");
const elPlayerName = document.getElementById("playerName");

const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");

const soundToggle = document.getElementById("soundToggle");
const musicToggle = document.getElementById("musicToggle");
const autoNextToggle = document.getElementById("autoNextToggle");

const cardLabel = document.getElementById("cardLabel");
const cardText  = document.getElementById("cardText");

const orderBox = document.getElementById("orderBox");
const options  = document.getElementById("options");

const progressBar = document.getElementById("progressBar");
const progressLabel = document.getElementById("progressLabel");

const resetOrderBtn = document.getElementById("resetOrder");
const checkOrderBtn = document.getElementById("checkOrder");
const nextBtn = document.getElementById("nextBtn");
const downloadBtn = document.getElementById("downloadReport");

const feedbackOverlay = document.getElementById("feedbackOverlay");
const fbCard = document.getElementById("fbCard");
const fbIcon = document.getElementById("fbIcon");
const fbTitle = document.getElementById("fbTitle");
const fbSub = document.getElementById("fbSub");
const fbDetail = document.getElementById("fbDetail");
const fbCloseBtn = document.getElementById("fbCloseBtn");
const fbNextBtn = document.getElementById("fbNextBtn");

const celebration = document.getElementById("celebration");
const celebrationDownload = document.getElementById("celebrationDownload");
const celebrationRestart = document.getElementById("celebrationRestart");

const bgMusic = document.getElementById("bgMusic");

const state = {
  running:false,
  startedAt:0,
  timerHandle:null,

  score:0,
  streak:0,
  targetStreak:25,

  round:0,
  totalRounds: 25, // progress bar target
  lastRoundWasCorrect:false,

  current:null, // { bank, sentence, correctTense, mode, correctWords }
  selectedWords: [],

  report: [] // rows for CSV
};

/* =========================================================
   UTIL
   ========================================================= */
function now(){ return Date.now(); }

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function cleanWords(sentence){
  // Keep punctuation attached to word tokens so student can rebuild correctly.
  // Example: "Do you like spicy food?" -> ["Do","you","like","spicy","food?"]
  return sentence.trim().split(/\s+/);
}

function setProgress(){
  const pct = Math.max(0, Math.min(100, Math.round((state.round / state.totalRounds) * 100)));
  progressBar.style.width = pct + "%";
  progressLabel.textContent = `Progress ${pct}%`;
  progressBar.classList.toggle("moving", state.running);
}

function updateStats(){
  elScore.textContent = `Score: ${state.score}`;
  elStreak.textContent = `Streak: ${state.streak}`;
  document.getElementById("targetLabel").textContent = state.targetStreak;
}

function spawnParticles(ok=true){
  if(!soundToggle.checked) return;
  const layer = document.getElementById("fxLayer");
  const n = ok ? 18 : 12;
  for(let i=0;i<n;i++){
    const p = document.createElement("div");
    p.className = "p";
    const x = (layer.clientWidth/2) + (Math.random()*80-40);
    const y = (layer.clientHeight/2) + (Math.random()*40-20);
    p.style.left = x+"px";
    p.style.top = y+"px";
    const dx = (Math.random()*260-130) + "px";
    const dy = (Math.random()*220-110) + "px";
    p.style.setProperty("--dx", dx);
    p.style.setProperty("--dy", dy);
    p.style.background = ok ? "#22c55e" : "#ef4444";
    layer.appendChild(p);
    setTimeout(()=>p.remove(), 700);
  }
}

function showPopup({ok, title, sub, detail}){
  feedbackOverlay.classList.add("show");
  feedbackOverlay.setAttribute("aria-hidden","false");

  fbCard.classList.remove("success","error");
  fbCard.classList.add(ok ? "success" : "error");

  fbIcon.textContent = ok ? "‚úÖ" : "‚ùå";
  fbTitle.textContent = title;

  fbSub.classList.remove("good","bad");
  fbSub.classList.add(ok ? "good" : "bad");
  fbSub.textContent = sub;

  fbDetail.innerHTML = detail;
}

function hidePopup(){
  feedbackOverlay.classList.remove("show");
  feedbackOverlay.setAttribute("aria-hidden","true");
}

function safePlayMusic(){
  if(!musicToggle.checked) return;
  bgMusic.volume = 0.22;
  bgMusic.play().catch(()=>{/* browser requires user interaction */});
}

function stopMusic(){
  bgMusic.pause();
  bgMusic.currentTime = 0;
}

function csvEscape(s){
  const str = String(s ?? "");
  if(/[",\n]/.test(str)) return `"${str.replaceAll('"','""')}"`;
  return str;
}

function downloadCSV(){
  const header = ["timestamp","player","bank","sentence","mode","answer","correct","result","streak","score"];
  const rows = state.report.map(r => header.map(h => csvEscape(r[h])).join(","));
  const csv = header.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "present-tense-practice-report.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================================================
   ROUND GENERATION
   ========================================================= */
function pickRound(){
  const bank = BANKS[Math.floor(Math.random()*BANKS.length)];
  const sentence = bank.list[Math.floor(Math.random()*bank.list.length)];

  // 55% multiple choice, 45% ordering (you can tweak)
  const mode = Math.random() < 0.55 ? "mc" : "order";

  const correctWords = cleanWords(sentence);
  return {
    bank,
    sentence,
    correctTense: bank.tense, // "PS" or "PC"
    mode,
    correctWords
  };
}

function setCardForRound(r){
  // IMPORTANT: for ORDER mode, DO NOT SHOW the sentence.
  cardLabel.textContent = r.bank.name;

  if(r.mode === "order"){
    cardText.textContent = "Build the sentence using ONLY the scrambled words below.";
  }else{
    // In MC mode, we can show the sentence (it's the prompt)
    cardText.textContent = r.sentence;
  }
}

/* =========================================================
   RENDER MODES
   ========================================================= */
function clearOrderState(){
  // ‚úÖ BULLETPROOF: never prefill the answer
  state.selectedWords = [];
  orderBox.innerHTML = "";
  orderBox.textContent = "Your selected words will appear here.";
}

function renderMC(r){
  options.className = "mode-multiple";
  options.innerHTML = "";

  resetOrderBtn.style.display = "none";
  checkOrderBtn.style.display = "none";
  nextBtn.style.display = "none";

  // Two big choices: Present Simple vs Present Continuous
  const mk = (tense) => {
    const btn = document.createElement("button");
    btn.className = `choiceCard ${tense==="PS" ? "choicePS" : "choicePC"}`;
    btn.type = "button";
    btn.innerHTML = `
      <div class="choiceIcon">${tense==="PS" ? "üü¶" : "üü©"}</div>
      <div class="choiceText">
        ${tense==="PS" ? "Present Simple" : "Present Continuous"}
        <small>${tense==="PS" ? "habits ‚Ä¢ facts ‚Ä¢ routines" : "now ‚Ä¢ temporary ‚Ä¢ in progress"}</small>
      </div>
    `;
    btn.onclick = () => submitMC(tense);
    return btn;
  };

  options.appendChild(mk("PS"));
  options.appendChild(mk("PC"));

  // Order box message for MC mode
  orderBox.textContent = "Tip: Decide the tense first (Simple vs Continuous).";
}

function renderOrder(r){
  options.className = "mode-order";
  options.innerHTML = "";

  resetOrderBtn.style.display = "inline-block";
  checkOrderBtn.style.display = "inline-block";
  nextBtn.style.display = "none"; // only after check (and if autoNext is off)

  clearOrderState(); // ‚úÖ ensure empty

  // Render SCRAMBLED words only (do NOT show the correct sentence anywhere)
  const scrambled = shuffle(r.correctWords);

  scrambled.forEach((w)=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "orderWord";
    btn.textContent = w;
    btn.onclick = ()=> addWord(w, btn);
    options.appendChild(btn);
  });

  resetOrderBtn.onclick = ()=> resetOrder(r);
  checkOrderBtn.onclick = ()=> checkOrder(r);
}

function addWord(word, btn){
  state.selectedWords.push(word);
  btn.disabled = true;

  // chip appears in orderBox
  if(orderBox.textContent.includes("selected words will appear here")) orderBox.textContent = "";
  const chip = document.createElement("span");
  chip.className = "selChip";
  chip.textContent = word;

  chip.onclick = () => {
    // remove ONE occurrence at correct index of this chip
    const idx = Array.from(orderBox.children).indexOf(chip);
    if(idx >= 0) state.selectedWords.splice(idx,1);
    btn.disabled = false;
    chip.remove();
    if(orderBox.children.length === 0){
      orderBox.textContent = "Your selected words will appear here.";
    }
  };

  orderBox.appendChild(chip);
}

function resetOrder(r){
  // re-enable all buttons
  options.querySelectorAll(".orderWord").forEach(b=>b.disabled=false);
  clearOrderState();
}

/* =========================================================
   SUBMIT + FEEDBACK
   ========================================================= */
function logResult({answer, correct, ok}){
  const player = document.getElementById("studentName").value.trim() || "‚Äî";
  state.report.push({
    timestamp: new Date().toISOString(),
    player,
    bank: state.current.bank.name,
    sentence: state.current.sentence,
    mode: state.current.mode,
    answer,
    correct,
    result: ok ? "correct" : "incorrect",
    streak: state.streak,
    score: state.score
  });
}

function submitMC(choice){
  const r = state.current;
  const ok = (choice === r.correctTense);

  if(ok){
    state.score += 10;
    state.streak += 1;
  }else{
    state.score = Math.max(0, state.score - 4);
    state.streak = 0;
  }
  state.round += 1;

  updateStats();
  setProgress();
  spawnParticles(ok);

  logResult({
    answer: choice === "PS" ? "Present Simple" : "Present Continuous",
    correct: r.correctTense === "PS" ? "Present Simple" : "Present Continuous",
    ok
  });

  const detail = `
    <div><b>Sentence:</b> ${escapeHtml(r.sentence)}</div>
    <div style="margin-top:8px"><b>Correct tense:</b> ${r.correctTense==="PS" ? "Present Simple" : "Present Continuous"}</div>
  `;

  showPopup({
    ok,
    title: ok ? "Correct!" : "Not yet!",
    sub: ok ? "Nice choice ‚Äî keep the streak going." : "Try again next round ‚Äî you‚Äôve got this.",
    detail
  });

  state.lastRoundWasCorrect = ok;
  afterRoundMaybeCelebrate();
  if(autoNextToggle.checked) {
    // allow students to see popup; then next
    fbNextBtn.style.display = "inline-block";
  } else {
    fbNextBtn.style.display = "inline-block";
  }
}

function checkOrder(r){
  // must have same number of words
  const answerWords = state.selectedWords.slice();
  const correctWords = r.correctWords.slice();

  const answer = answerWords.join(" ");
  const correct = correctWords.join(" ");

  const ok = (answerWords.length === correctWords.length) && answerWords.every((w,i)=>w === correctWords[i]);

  if(ok){
    state.score += 12;
    state.streak += 1;
  }else{
    state.score = Math.max(0, state.score - 4);
    state.streak = 0;
  }
  state.round += 1;

  updateStats();
  setProgress();
  spawnParticles(ok);

  logResult({ answer, correct, ok });

  // IMPORTANT: show the correct sentence ONLY now (in the popup)
  const detail = `
    <div><b>Your answer:</b> ${escapeHtml(answer || "‚Äî")}</div>
    <div style="margin-top:10px"><b>Correct sentence:</b> <span style="color:${ok ? "#22c55e" : "#f59e0b"}">${escapeHtml(correct)}</span></div>
    <div style="margin-top:10px"><b>Tip:</b> Watch word order + auxiliary verbs (do/does/are/is).</div>
  `;

  showPopup({
    ok,
    title: ok ? "Correct sentence!" : "Almost ‚Äî check the order",
    sub: ok ? "Great! You built it correctly." : "No worries. Look at the correct sentence and try again next time.",
    detail
  });

  // lock buttons after check
  options.querySelectorAll(".orderWord").forEach(b=>b.disabled=true);
  resetOrderBtn.disabled = true;
  checkOrderBtn.disabled = true;

  state.lastRoundWasCorrect = ok;
  afterRoundMaybeCelebrate();

  // Show Next button only if auto-next is OFF; otherwise popup Next is enough.
  nextBtn.style.display = autoNextToggle.checked ? "none" : "inline-block";
}

function afterRoundMaybeCelebrate(){
  if(state.streak >= state.targetStreak){
    celebration.style.display = "flex";
    celebration.setAttribute("aria-hidden","false");
    downloadBtn.style.display = "inline-block";
  }else{
    downloadBtn.style.display = state.report.length ? "inline-block" : "none";
  }
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   ROUND FLOW
   ========================================================= */
function renderRound(){
  const r = state.current;
  // reset action buttons state
  resetOrderBtn.disabled = false;
  checkOrderBtn.disabled = false;

  setCardForRound(r);

  if(r.mode === "mc"){
    renderMC(r);
  }else{
    renderOrder(r);
  }

  nextBtn.onclick = ()=> nextRound();
}

function nextRound(){
  hidePopup();

  // if celebration is open, don't continue until restart
  if(celebration.style.display === "flex") return;

  state.current = pickRound();
  renderRound();

  // unlock controls
  resetOrderBtn.disabled = false;
  checkOrderBtn.disabled = false;
}

/* =========================================================
   START/RESET/TIMER
   ========================================================= */
function startGame(){
  const player = document.getElementById("studentName").value.trim();
  elPlayerName.textContent = player || "‚Äî";

  state.running = true;
  state.startedAt = now();

  if(state.timerHandle) clearInterval(state.timerHandle);
  state.timerHandle = setInterval(()=>{
    if(!state.running) return;
    const seconds = Math.floor((now() - state.startedAt)/1000);
    elTimer.textContent = `Time: ${seconds}s`;
  }, 250);

  updateStats();
  setProgress();

  safePlayMusic();

  state.current = pickRound();
  renderRound();

  downloadBtn.style.display = "none";
}

function resetGame(){
  hidePopup();
  celebration.style.display = "none";
  celebration.setAttribute("aria-hidden","true");

  state.running = false;
  if(state.timerHandle) clearInterval(state.timerHandle);
  state.timerHandle = null;

  state.score = 0;
  state.streak = 0;
  state.round = 0;
  state.report = [];
  state.current = null;
  state.selectedWords = [];

  elTimer.textContent = "Time: 0s";
  updateStats();
  setProgress();

  options.className = "";
  options.innerHTML = "";
  cardLabel.textContent = "Read and answer";
  cardText.textContent = "Press START to begin";
  orderBox.textContent = "Your selected words will appear here.";

  resetOrderBtn.style.display = "none";
  checkOrderBtn.style.display = "none";
  nextBtn.style.display = "none";
  downloadBtn.style.display = "none";

  stopMusic();
}

/* =========================================================
   EVENTS
   ========================================================= */
startBtn.addEventListener("click", ()=>{
  if(!state.running) startGame();
});
resetBtn.addEventListener("click", resetGame);

musicToggle.addEventListener("change", ()=>{
  if(musicToggle.checked) safePlayMusic();
  else stopMusic();
});

fbCloseBtn.addEventListener("click", ()=>{
  hidePopup();
  // If auto-next is ON, keep user able to continue via Next in popup
});
fbNextBtn.addEventListener("click", ()=>{
  hidePopup();
  if(celebration.style.display === "flex") return;
  nextRound();
});

downloadBtn.addEventListener("click", downloadCSV);
celebrationDownload.addEventListener("click", downloadCSV);
celebrationRestart.addEventListener("click", ()=>{
  resetGame();
  startGame();
});

/* allow clicking outside popup card to close */
feedbackOverlay.addEventListener("click", (e)=>{
  if(e.target === feedbackOverlay) hidePopup();
});

/* =========================================================
   Initialize
   ========================================================= */
updateStats();
setProgress();
</script>
</body>
</html>


