<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Present Tense Practice ‚Äî Youth Neat</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  /* Youth / neat / high-contrast */
  --bg1:#070a1a;
  --bg2:#0b1b3a;
  --bg3:#051827;

  --panel:#ffffff;
  --panel2:#f6fbff;

  --text:#0c1a2e;
  --muted:#58677a;

  /* Strong, differentiated colors */
  --ps:#2563eb;      /* electric blue */
  --ps2:#1d4ed8;
  --pc:#10b981;      /* neon green */
  --pc2:#0f766e;

  --accent:#a855f7;  /* purple */
  --cardA:#7c3aed;
  --cardB:#db2777;
  --cardC:#f59e0b;

  --success:#22c55e;
  --error:#ef4444;

  --stroke: rgba(15, 23, 42, .12);
  --shadow: 0 26px 70px rgba(0,0,0,0.42);

  --wMax: 1120px;

  /* dynamic sizing for order words */
  --wordFont: 16px;
  --wordPadY: 10px;
  --wordPadX: 12px;
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Montserrat,system-ui,sans-serif;
  background:
    radial-gradient(1000px 600px at 10% 20%, rgba(168,85,247,.22), transparent 55%),
    radial-gradient(900px 560px at 85% 20%, rgba(16,185,129,.18), transparent 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}

/* NO SCROLL: everything must fit */
.container{
  width:min(var(--wMax), 100%);
  height:calc(100vh - 24px);
  max-height:900px;
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  display:grid;
  grid-template-columns: 1fr 290px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:hidden; /* hard no-scroll */
}

/* Header */
.header{
  grid-column:1/2;
  grid-row:1/2;
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:58px;height:58px;border-radius:16px;
  background:linear-gradient(180deg,#fff,#fff5ff);
  border:1px solid var(--stroke);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 12px 24px rgba(2,6,23,0.10);
}
.title{margin:0;font-size:20px;color:var(--accent);letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--muted)}

/* Topbar */
.topbar{
  grid-column:1/2;
  grid-row:2/3;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:#fff;
  border:1px solid var(--stroke);
  border-radius:16px;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:linear-gradient(180deg,#fff,#f8fbff);
}
.playerTag{font-size:13px;color:var(--muted)}
.playerTag strong{color:#0b172a}

/* Controls panel */
.controlsPanel{
  grid-column:2/3;
  grid-row:1/4;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding:12px;
  border:1px solid var(--stroke);
  border-radius:16px;
  background:linear-gradient(180deg,#fff,#f1f6ff);
  overflow:hidden;
}
.inputRow{display:flex;flex-direction:column;gap:6px}
.inputRow label{font-weight:900;font-size:13px;color:#0b172a}
.inputRow input{
  border:1px solid rgba(15,23,42,.16);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input:focus{
  border-color: rgba(168,85,247,.65);
  box-shadow:0 0 0 5px rgba(168,85,247,.18);
}
.lockedHint{font-size:12px;color:var(--muted);margin-top:-4px;line-height:1.25}
.controlsBtns{display:flex;gap:10px}
.btnPrimary{
  width:50%;
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  color:#fff;
  cursor:pointer;
  background:linear-gradient(180deg,var(--accent),#6d28d9);
  box-shadow:0 12px 26px rgba(2,6,23,.12);
  transition:transform .12s ease, filter .12s ease;
}
.btnSecondary{
  width:50%;
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  color:#0b172a;
  cursor:pointer;
  background:#fff;
  transition:transform .12s ease;
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.03)}
.soundRow{font-size:13px;color:var(--muted)}
.tipBox{
  margin-top:auto;
  padding:12px;
  border-radius:14px;
  border:1px dashed rgba(15,23,42,.18);
  background:rgba(168,85,247,.06);
  font-size:12.5px;
  color:#334155;
  line-height:1.35;
}

/* Game (NO SCROLL) */
.game{
  grid-column:1/2;
  grid-row:3/4;
  overflow:hidden; /* no scroll */
  display:flex;
  align-items:stretch;
  justify-content:center;
}
.gameInner{
  width:100%;
  max-width:760px;
  height:100%;
  display:grid;
  grid-template-rows: 1fr auto auto auto auto auto; /* card grows, rest auto */
  gap:10px;
  overflow:hidden;
}

/* Card: readable, youth vibe */
#card{
  border-radius:18px;
  padding:14px;
  background:linear-gradient(135deg,var(--cardA),var(--cardB),var(--cardC));
  box-shadow:0 18px 48px rgba(2,6,23,0.22);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  overflow:hidden;
  position:relative;
}
#card::before{
  content:"";
  position:absolute; inset:-25%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.22), transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,.18), transparent 48%),
    radial-gradient(circle at 70% 75%, rgba(255,255,255,.14), transparent 52%);
  transform:rotate(-10deg);
  pointer-events:none;
}
#cardLabel{
  position:relative;
  font-size:14px;
  font-weight:900;
  color:#fff;
  padding:9px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter: blur(8px);
  margin:0 0 10px;
}
#cardText{
  position:relative;
  width:min(92%, 700px);
  padding:12px 14px;
  border-radius:16px;
  background:rgba(0,0,0,.20);
  border:1px solid rgba(255,255,255,.20);
  color:#fff;
  font-weight:900;
  font-size:clamp(22px, 2.4vw, 32px);
  line-height:1.12;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
}

/* Order box */
#orderBox{
  border:1px solid var(--stroke);
  border-radius:16px;
  background:#fff;
  padding:10px;
  min-height:64px; /* tighter for no-scroll */
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:var(--text);
  overflow:hidden;
}

/* Options: neat layouts */
#options{
  width:100%;
  overflow:hidden; /* no scroll */
}

/* Multiple choice = 2 big youth cards */
#options.mode-multiple{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.choiceCard{
  border:none;
  border-radius:18px;
  padding:14px 14px;
  color:#fff;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  box-shadow:0 14px 30px rgba(2,6,23,.14);
  transition:transform .12s ease, filter .12s ease;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:78px;
}
.choiceCard:hover{transform:translateY(-2px);filter:brightness(1.05)}
.choiceCard:disabled{opacity:.65;cursor:not-allowed;transform:none !important}
.choiceIcon{
  width:44px;height:44px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.18);
  font-size:22px;
}
.choiceText small{display:block;font-size:12px;font-weight:800;opacity:.92;margin-top:2px}

/* PS vs PC colors */
.choicePS{background:linear-gradient(135deg,var(--ps),var(--ps2))}
.choicePC{background:linear-gradient(135deg,var(--pc),var(--pc2))}

/* Order mode: compact grid chips */
#options.mode-order{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap:8px;
  align-content:start;
}
.orderWord{
  border:none;
  border-radius:16px;
  padding: var(--wordPadY) var(--wordPadX);
  font-weight:900;
  font-size: var(--wordFont);
  cursor:pointer;
  color:#0b172a;
  background:linear-gradient(180deg,#ffffff,#eef2ff);
  border:1px solid rgba(37,99,235,.22);
  box-shadow:0 10px 18px rgba(2,6,23,.08);
  transition:transform .12s ease, filter .12s ease;
}
.orderWord:hover{transform:translateY(-2px);filter:brightness(1.02)}
.orderWord:disabled{opacity:.55;cursor:not-allowed;transform:none !important}
.orderWord.chosen{
  color:#fff;
  border-color: rgba(239,68,68,.40);
  background:linear-gradient(180deg,#ef4444,#b91c1c);
}

/* Progress smaller but lively */
.progressWrap{
  width:100%;
  height:12px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid var(--stroke);
  background:#e5e7ff;
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#16a34a,#22c55e);
  background-size:200% 100%;
  transition:width 600ms ease;
}
.progressBar.moving{ animation: prog 1.1s linear infinite; }
@keyframes prog{ 0%{background-position:0%} 100%{background-position:200%} }
.progressLabel{font-size:12px;color:var(--muted);margin-top:-4px;text-align:center}

/* Feedback + controls */
#feedback{
  min-height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-weight:900;
  color:#0b172a;
}
.controlsRow{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
}
.smallBtn{
  border:1px solid var(--stroke);
  background:#fff;
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease;
}
.smallBtn:hover{transform:translateY(-2px)}
.smallBtn:disabled{opacity:.6;cursor:not-allowed;transform:none !important}

/* Footer */
.footer{
  grid-column:1/2;
  grid-row:4/5;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--muted);
  font-size:13px;
}

/* Celebration overlay */
.celebration-overlay{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(2,8,23,0.68);
  z-index:9999;
  padding:18px;
}
.celebration-card{
  width:min(760px, 100%);
  background:linear-gradient(180deg,#fff,#fffefc);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.55);
}
.celebration-title{font-size:34px;font-weight:900;color:var(--accent);margin-bottom:8px}
.celebration-actions{display:flex;gap:12px;justify-content:center;margin-top:12px}

/* Visible animations */
@keyframes fadeUp{0%{opacity:0;transform:translateY(10px) scale(.98)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}100%{transform:translateX(0)}}
.animate-in{animation:fadeUp .30s ease both}
.pop{animation:pop .20s ease}
.shake{animation:shake .28s ease}

/* Responsive: stack on narrow screens, still no scroll (shrink sizes) */
@media (max-width: 980px){
  .container{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr auto auto;
  }
  .controlsPanel{
    grid-column:1/2;
    grid-row:5/6;
    flex-direction:row;
    flex-wrap:wrap;
    align-items:flex-start;
    gap:10px;
  }
  .inputRow{width:calc(50% - 5px)}
  .controlsBtns{width:100%}
  .tipBox{width:100%; margin-top:0}
}
@media (max-width: 640px){
  .inputRow{width:100%}
  #options.mode-multiple{grid-template-columns: 1fr}
  .choiceCard{min-height:70px}
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .animate-in,.pop,.shake,.progressBar.moving{animation:none !important}
  *{transition:none !important}
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Practica tiempos">
    <!-- Header -->
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="38" height="38" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#a855f7"/>
              <stop offset="1" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Present Tense Practice</h1>
        <p class="lead">Neat ‚Ä¢ juvenil ‚Ä¢ colores claros ‚Ä¢ objetivo: <b>25 seguidas</b></p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="score">Score: 0</div>
        <div class="stat" id="timer">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="playerTag">Jugador: <strong id="playerName">‚Äî</strong></div>
    </div>

    <!-- Controls -->
    <div class="controlsPanel">
      <div class="inputRow">
        <label for="studentName">Nombre</label>
        <input id="studentName" type="text" placeholder="Ej: Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Racha objetivo</label>
        <input id="targetStreak" type="number" value="25" disabled>
        <div class="lockedHint">Fijada en 25 ‚úÖ</div>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary">START</button>
        <button id="resetBtn" class="btnSecondary">RESET</button>
      </div>

      <label class="soundRow"><input id="soundToggle" type="checkbox" checked> Sonidos</label>

      <div class="tipBox">
        <b>C√≥mo jugar</b><br>
        ‚Ä¢ Dos tarjetas: elige el tiempo verbal.<br>
        ‚Ä¢ ‚ÄúOrder the sentence‚Äù: toca palabras para ordenar.<br>
        ‚Ä¢ Puedes reiniciar el orden si te l√≠as.
      </div>
    </div>

    <!-- Game -->
    <div class="game" role="main" aria-live="polite">
      <div class="gameInner">
        <div id="card" role="region" aria-label="Tarjeta">
          <div id="cardLabel">Lee y responde</div>
          <div id="cardText">Pulsa START para comenzar</div>
        </div>

        <div id="orderBox" aria-live="polite">Aqu√≠ aparecer√°n tus palabras.</div>

        <div id="options" role="group" aria-label="Opciones"></div>

        <div class="progressWrap" aria-hidden="false">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Progreso 0%</div>

        <div id="feedback" aria-live="assertive"></div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none">Reiniciar orden</button>
          <button id="nextBtn" class="smallBtn" style="display:none">Siguiente</button>
          <button id="downloadReport" class="smallBtn" style="display:none">CSV</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div>Banco: Present Simple / Present Continuous ‚Äî 6 categor√≠as</div>
      <div>Objetivo: <span id="targetLabel">25</span> seguidas</div>
    </div>

    <!-- Celebration -->
    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">¬°Level Up! üî•</div>
        <div id="celebrationSub" style="color:var(--muted);font-weight:900">Has alcanzado la racha objetivo.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary" style="width:auto;padding:12px 18px">Descargar CSV</button>
          <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Bancos (6 x 20) ---------- */
const PS_aff = ["She usually walks to school.","He plays the guitar every afternoon.","They enjoy quiet mornings together.","My cat sleeps on my backpack.","I like how this coffee smells.","We read the newspaper every morning.","The bus arrives at eight o'clock.","Tom studies French at university.","Anna works in a small bakery.","Birds fly south in winter.","The shop opens at nine every day.","He drinks green tea after lunch.","Students practice vocabulary every evening.","She always helps her neighbors.","The sun rises in the east.","He writes emails every morning.","We celebrate birthdays with cake.","The teacher explains the lesson clearly.","She takes the dog for a walk daily.","They visit the museum on weekends."];
const PS_neg = ["She doesn't like cold pizza.","They don't study on Sundays.","He does not enjoy long movies.","I don't drink soda anymore.","The cat doesn't sleep in its bed.","We don't watch TV at night.","He doesn't own a car.","She does not eat meat.","They don't arrive early.","I don't understand this word.","She doesn't answer her phone often.","We don't use that old computer anymore.","He doesn't believe the rumor.","They don't accept late homework.","I don't remember his name.","She doesn't drive to work.","He doesn't like loud music.","We don't go out when it rains.","The store doesn't open on Sundays.","He doesn't speak Spanish."];
const PS_int = ["Do you like spicy food?","Does she play the violin?","Do they live near here?","Does he enjoy swimming?","Do we have class today?","Do you speak English?","Does it rain a lot here?","Do they know the answer?","Does she work on Saturdays?","Do I need to bring a book?","Do you usually study in the morning?","Does he visit his grandparents every week?","Do they play chess after school?","Does she cook for the family?","Do we meet at the library?","Do you understand the instructions?","Does he take the train to work?","Do they practice every day?","Does she prefer tea or coffee?","Do I have to finish this today?"];
const PC_aff = ["She's studying English right now.","They are cooking dinner together.","He's drawing a robot at the moment.","I'm listening to music.","We're walking to the bus stop.","She is reading a new novel.","They are playing football in the park.","He is fixing his bicycle.","I'm watching a documentary.","We are preparing for the exam.","She is practicing the piano this afternoon.","They are building a model in the workshop.","He is cleaning his room right now.","I'm checking my email at the moment.","We are learning a new song today.","She is talking on the phone now.","They are planting flowers in the garden.","He is repairing the fence this morning.","I'm making a sandwich right now.","We are discussing the project together."];
const PC_neg = ["She isn't studying for the test right now.","They aren't watching TV at the moment.","He is not working today.","I'm not feeling well this morning.","We aren't using the old printer now.","She isn't listening to the radio.","They aren't playing the piano today.","He isn't driving to the office this week.","I'm not eating meat this week.","We aren't meeting them tonight.","She isn't wearing her new coat today.","They aren't staying at the hotel this time.","He is not answering his phone now.","I'm not taking the bus today.","We aren't studying that chapter now.","She isn't practicing the song today.","They aren't building the shelf this afternoon.","He isn't fixing the car right now.","I'm not watching the match at the moment.","We aren't preparing dinner yet."];
const PC_int = ["Is she studying English now?","Are they cooking dinner together?","Is he drawing a robot at the moment?","Am I listening to the right track?","Are we walking to the bus stop?","Is she reading a new novel now?","Are they playing football in the park?","Is he fixing his bicycle right now?","Am I watching the documentary?","Are we preparing for the exam?","Is she practicing the piano this afternoon?","Are they building a model in the workshop?","Is he cleaning his room at the moment?","Am I checking my email now?","Are we learning a new song today?","Is she talking on the phone now?","Are they planting flowers in the garden?","Is he repairing the fence this morning?","Am I making a sandwich right now?","Are we discussing the project together?"];

/* ---------- Estado ---------- */
let pools = null;
let current = {};
let score = 0;
let timer = 0;
let timerInterval = null;
let playerName = "";
let consecutiveCorrect = 0;

const TARGET_STREAK_FIXED = 25;
let TARGET_STREAK = TARGET_STREAK_FIXED;

let attemptsLog = [];
let soundEnabled = true;

/* ---------- Anim helpers ---------- */
function addAnim(el, cls){
  if(!el) return;
  el.classList.remove(cls);
  void el.offsetWidth;
  el.classList.add(cls);
}
function animateIn(){
  addAnim(document.getElementById('card'), 'animate-in');
  addAnim(document.getElementById('options'), 'animate-in');
  addAnim(document.getElementById('orderBox'), 'animate-in');
}

/* ---------- Audio ---------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
async function ensureAudioReady(){
  try{ if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume(); }catch(_){}
}
function playTone(type){
  if(!soundEnabled || !audioCtx) return;
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  if(type === 'correct'){
    o.frequency.setValueAtTime(880, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.01);
    o.frequency.exponentialRampToValueAtTime(1320, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  } else {
    o.frequency.setValueAtTime(220, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.09, now+0.01);
    o.frequency.exponentialRampToValueAtTime(160, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  }
  o.start(now); o.stop(now+0.3);
}

/* ---------- Utils ---------- */
function clearTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }
function startTimer(){
  clearTimer();
  timer = 0;
  document.getElementById("timer").textContent = "Time: 0s";
  timerInterval = setInterval(()=> {
    timer++;
    document.getElementById("timer").textContent = "Time: " + timer + "s";
  },1000);
}
function normalizeString(s){
  if(!s) return "";
  return s.replace(/[\u2018\u2019\u201C\u201D]/g,"'")
          .replace(/[?.,!;:()"]/g,"")
          .replace(/\s+/g," ")
          .trim()
          .toLowerCase();
}
function shuffleArray(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ---------- Pools ---------- */
function buildPools(){
  pools = {
    aff: shuffleArray(PS_aff.slice()),
    neg: shuffleArray(PS_neg.slice()),
    int: shuffleArray(PS_int.slice()),
    contAff: shuffleArray(PC_aff.slice()),
    contNeg: shuffleArray(PC_neg.slice()),
    contInt: shuffleArray(PC_int.slice())
  };
}

/* ---------- Progress ---------- */
function setProgressPercent(pct){
  const bar = document.getElementById('progressBar');
  pct = Math.max(0, Math.min(100, Math.round(pct)));
  bar.style.width = pct + '%';
  document.getElementById('progressLabel').textContent = 'Progreso ' + pct + '%';
  if(pct > 0) bar.classList.add('moving'); else bar.classList.remove('moving');
}

/* ---------- UI: START / RESET ---------- */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  await ensureAudioReady();
  const nameInput = document.getElementById('studentName').value.trim();
  if(!nameInput){ alert('Escribe tu nombre.'); document.getElementById('studentName').focus(); return; }

  playerName = nameInput;
  TARGET_STREAK = TARGET_STREAK_FIXED;
  consecutiveCorrect = 0;
  score = 0;
  attemptsLog = [];

  document.getElementById('playerName').textContent = playerName;
  document.getElementById('score').textContent = 'Score: 0';
  document.getElementById('streakBox').textContent = 'Streak: 0';
  document.getElementById('targetLabel').textContent = TARGET_STREAK_FIXED;

  soundEnabled = document.getElementById('soundToggle').checked;
  buildPools();
  setProgressPercent(0);

  nextQuestion();
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  clearTimer();
  document.getElementById('studentName').value = '';
  playerName = '';
  consecutiveCorrect = 0; score = 0; attemptsLog = [];

  document.getElementById('playerName').textContent = '‚Äî';
  document.getElementById('score').textContent = 'Score: 0';
  document.getElementById('timer').textContent = 'Time: 0s';
  document.getElementById('streakBox').textContent = 'Streak: 0';
  setProgressPercent(0);

  document.getElementById('cardLabel').textContent = 'Lee y responde';
  document.getElementById('cardLabel').style.display = 'block';
  document.getElementById('cardText').textContent = 'Pulsa START para comenzar';

  document.getElementById('orderBox').textContent = 'Aqu√≠ aparecer√°n tus palabras.';
  document.getElementById('options').innerHTML = '';
  document.getElementById('feedback').textContent = '';

  document.getElementById('resetOrder').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('downloadReport').style.display = 'none';
});

/* ---------- Next question ---------- */
function nextQuestion(){
  if(consecutiveCorrect >= TARGET_STREAK) return;

  clearTimer();
  clearFeedback();

  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('resetOrder').style.display = 'none';

  document.getElementById('orderBox').textContent = '';
  document.getElementById('options').innerHTML = '';
  document.getElementById('options').className = '';
  document.getElementById('cardLabel').style.display = 'block';
  document.getElementById('cardLabel').textContent = 'Lee y responde';
  document.getElementById('cardText').textContent = '';

  const chooseContinuous = Math.random() < 0.5;
  if(chooseContinuous){
    const types = ['contAff','contNeg','contInt'];
    const chosen = types[Math.floor(Math.random()*types.length)];
    if(!pools || !pools[chosen] || pools[chosen].length === 0) buildPools();
    const text = pools[chosen].pop();
    current = { text, correct: 'Present Continuous', structure: chosen, mode: Math.random() < 0.5 ? 'multiple' : 'order', typed: [], startTime: Date.now() };
  } else {
    const types = ['aff','neg','int'];
    const chosen = types[Math.floor(Math.random()*types.length)];
    if(!pools || !pools[chosen] || pools[chosen].length === 0) buildPools();
    const text = pools[chosen].pop();
    current = { text, correct: 'Present Simple', structure: chosen, mode: Math.random() < 0.5 ? 'multiple' : 'order', typed: [], startTime: Date.now() };
  }

  renderQuestion();
}

/* ---------- Render ---------- */
function setDenseChips(wordCount){
  // Keep all chips visible with no scroll
  if(wordCount >= 14){
    document.documentElement.style.setProperty('--wordFont','13px');
    document.documentElement.style.setProperty('--wordPadY','8px');
    document.documentElement.style.setProperty('--wordPadX','10px');
  } else if(wordCount >= 11){
    document.documentElement.style.setProperty('--wordFont','14px');
    document.documentElement.style.setProperty('--wordPadY','9px');
    document.documentElement.style.setProperty('--wordPadX','11px');
  } else {
    document.documentElement.style.setProperty('--wordFont','16px');
    document.documentElement.style.setProperty('--wordPadY','10px');
    document.documentElement.style.setProperty('--wordPadX','12px');
  }
}

function renderQuestion(){
  startTimer();
  const options = document.getElementById('options');
  options.innerHTML = '';

  if(current.mode === 'multiple'){
    options.classList.add('mode-multiple');
    document.getElementById('cardLabel').textContent = 'Elige el tiempo verbal';
    document.getElementById('cardText').textContent = current.text;
    document.getElementById('orderBox').textContent = 'Elige una tarjeta:';

    const ps = document.createElement('button');
    ps.className = 'choiceCard choicePS';
    ps.innerHTML = `
      <div class="choiceIcon">üÖøÔ∏è</div>
      <div class="choiceText">
        <div style="font-size:18px">Present Simple</div>
        <small>Rutinas ‚Ä¢ hechos ‚Ä¢ h√°bitos</small>
      </div>`;
    ps.onclick = ()=> checkAnswer('Present Simple', ps);

    const pc = document.createElement('button');
    pc.className = 'choiceCard choicePC';
    pc.innerHTML = `
      <div class="choiceIcon">üîÑ</div>
      <div class="choiceText">
        <div style="font-size:18px">Present Continuous</div>
        <small>Ahora ‚Ä¢ hoy ‚Ä¢ en progreso</small>
      </div>`;
    pc.onclick = ()=> checkAnswer('Present Continuous', pc);

    options.appendChild(ps);
    options.appendChild(pc);
  } else {
    options.classList.add('mode-order');
    document.getElementById('cardLabel').textContent = 'Order the sentence';
    document.getElementById('cardText').textContent = 'üëá Ordena la frase con las palabras';

    document.getElementById('resetOrder').style.display = 'inline-block';
    document.getElementById('resetOrder').onclick = resetOrder;

    const cleaned = current.text.replace(/[\u2018\u2019\u201C\u201D]/g,"'");
    const words = cleaned.replace(/[?.,!;:()"]/g,"").split(/\s+/).filter(Boolean);

    if(words.length <= 1){
      current.mode = 'multiple';
      renderQuestion();
      return;
    }

    setDenseChips(words.length);

    let shuffled;
    let attempts = 0;
    do{
      shuffled = shuffleArray(words);
      attempts++;
      if(attempts > 12) break;
    } while(shuffled.join(' ') === words.join(' '));

    current.originalWords = words;
    current.shuffledWords = shuffled;
    current.typed = [];

    shuffled.forEach((w)=>{
      const b = document.createElement('button');
      b.className = 'orderWord';
      b.textContent = w;
      b.onclick = ()=> pickWord(w, b);
      options.appendChild(b);
    });

    updateOrderBox();
  }

  animateIn();
}

/* ---------- Order helpers ---------- */
function updateOrderBox(){
  const box = document.getElementById('orderBox');
  box.innerHTML = '';
  if(!current.typed || current.typed.length === 0){
    box.textContent = 'Aqu√≠ aparecer√°n tus palabras.';
    return;
  }
  current.typed.forEach((w, i)=>{
    const chip = document.createElement('span');
    chip.textContent = w;
    chip.style.padding = '8px 12px';
    chip.style.borderRadius = '14px';
    chip.style.background = '#e0e7ff';
    chip.style.border = '1px solid rgba(37,99,235,.20)';
    chip.style.fontWeight = '900';
    chip.style.cursor = 'pointer';
    chip.title = 'Clic para deshacer';
    chip.onclick = ()=> undoWord(i);
    box.appendChild(chip);
  });
}

function undoWord(index){
  const buttons = Array.from(document.querySelectorAll('#options button'));
  buttons.forEach(b => { b.disabled = false; b.classList.remove('chosen'); });

  current.typed = current.typed.slice(0, index);

  buttons.forEach(b=>{
    if(current.typed.includes(b.textContent)){
      b.classList.add('chosen');
      b.disabled = true;
    }
  });

  updateOrderBox();
  showFeedback('Deshecho ‚úÖ', 'neutral');
}

function resetOrder(){
  current.typed = [];
  Array.from(document.querySelectorAll('#options button')).forEach(b=>{
    b.disabled = false;
    b.classList.remove('chosen');
  });
  updateOrderBox();
  showFeedback('Reiniciado üîÅ', 'neutral');
}

/* ---------- Logging ---------- */
function logAttempt(entry){
  attemptsLog.push(entry);
  document.getElementById('downloadReport').style.display = 'inline-block';
}

/* ---------- Feedback ---------- */
function showFeedback(text, type){
  const fb = document.getElementById('feedback');
  if(type === 'success') fb.innerHTML = `<span style="font-size:20px">‚úÖ</span><span style="color:var(--success)">${text}</span>`;
  else if(type === 'error') fb.innerHTML = `<span style="font-size:20px">‚ùå</span><span style="color:var(--error)">${text}</span>`;
  else fb.textContent = text;
}
function clearFeedback(){
  const fb = document.getElementById('feedback');
  fb.textContent = '';
  fb.innerHTML = '';
}

/* ---------- Answer checks ---------- */
function handleCorrect(selected){
  score++;
  consecutiveCorrect++;

  document.getElementById('score').textContent = 'Score: ' + score;
  document.getElementById('streakBox').textContent = 'Streak: ' + consecutiveCorrect;

  showFeedback('¬°Correcto! üî•', 'success');
  playTone('correct');
  addAnim(document.getElementById('card'), 'pop');

  clearTimer();
  document.querySelectorAll('#options button').forEach(b=>b.disabled = true);

  document.getElementById('nextBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').onclick = nextQuestion;

  const timeTaken = Math.round((Date.now() - current.startTime)/1000);
  logAttempt({
    timestamp: new Date().toISOString(),
    student: playerName,
    sentence: current.text,
    mode: current.mode,
    structure: current.structure,
    selected: selected || '',
    correctLabel: current.correct,
    correct: true,
    timeTaken,
    streak: consecutiveCorrect
  });

  setProgressPercent((consecutiveCorrect / TARGET_STREAK) * 100);
  if(consecutiveCorrect >= TARGET_STREAK) showCelebration();
}

function handleWrong(selected){
  consecutiveCorrect = 0;
  document.getElementById('streakBox').textContent = 'Streak: 0';
  setProgressPercent(0);

  showFeedback('Incorrecto ‚Äî prueba otra vez', 'error');
  playTone('incorrect');
  addAnim(document.getElementById('card'), 'shake');

  const timeTaken = Math.round((Date.now() - current.startTime)/1000);
  logAttempt({
    timestamp: new Date().toISOString(),
    student: playerName,
    sentence: current.text,
    mode: current.mode,
    structure: current.structure,
    selected: selected || '',
    correctLabel: current.correct,
    correct: false,
    timeTaken,
    streak: consecutiveCorrect
  });
}

function checkAnswer(choice, btnEl){
  if(choice === current.correct){
    handleCorrect(choice);
  } else {
    if(btnEl) btnEl.style.filter = 'grayscale(.25) brightness(.95)';
    handleWrong(choice);
  }
}

function pickWord(word, btn){
  if(btn.disabled) return;
  btn.classList.add('chosen');
  btn.disabled = true;

  current.typed.push(word);
  updateOrderBox();

  const typed = normalizeString(current.typed.join(' '));
  const correct = normalizeString(current.originalWords.join(' '));

  if(typed === correct){
    document.getElementById('cardLabel').style.display = 'none';
    document.getElementById('cardText').textContent = current.originalWords.join(' ');
    handleCorrect(current.typed.join(' '));
    return;
  }

  if(current.typed.length === current.originalWords.length){
    document.getElementById('cardLabel').style.display = 'none';
    document.getElementById('cardText').textContent = current.originalWords.join(' ');

    clearTimer();
    document.querySelectorAll('#options button').forEach(b=>b.disabled = true);

    document.getElementById('nextBtn').style.display = 'inline-block';
    document.getElementById('nextBtn').onclick = nextQuestion;

    handleWrong(current.typed.join(' '));
    return;
  }

  showFeedback('Sigue‚Ä¶ üëÄ', 'neutral');
}

/* ---------- CSV ---------- */
function csvEscape(s){ return '"' + String(s ?? '').replace(/"/g,'""') + '"'; }
function downloadCSV(filename, rows){
  const header = ['timestamp','student','sentence','mode','structure','selected','correctLabel','correct','timeTaken_s','streak'];
  const lines = [header.join(',')];
  rows.forEach(r=>{
    lines.push([
      csvEscape(r.timestamp), csvEscape(r.student), csvEscape(r.sentence), csvEscape(r.mode),
      csvEscape(r.structure), csvEscape(r.selected), csvEscape(r.correctLabel), csvEscape(r.correct),
      csvEscape(r.timeTaken), csvEscape(r.streak)
    ].join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById('downloadReport').addEventListener('click', ()=>{
  if(attemptsLog.length === 0){ alert('No hay intentos.'); return; }
  const filename = `${playerName || 'student'}_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  downloadCSV(filename, attemptsLog);
});

/* ---------- Celebration ---------- */
function showCelebration(){
  const overlay = document.getElementById('celebration');
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
  document.getElementById('celebrationSub').textContent =
    `${playerName || 'Estudiante'} lleg√≥ a ${consecutiveCorrect} seguidas. ¬°Brutal!`;

  document.getElementById('celebrationDownload').onclick = ()=>{
    if(attemptsLog.length === 0){ alert('No hay intentos.'); return; }
    const filename = `${playerName || 'student'}_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    downloadCSV(filename, attemptsLog);
  };

  document.getElementById('celebrationRestart').onclick = ()=>{
    overlay.style.display='none';
    consecutiveCorrect = 0; score = 0; attemptsLog = [];
    document.getElementById('score').textContent = 'Score: 0';
    document.getElementById('streakBox').textContent = 'Streak: 0';
    setProgressPercent(0);
    buildPools();
    nextQuestion();
  };
}
document.getElementById('celebration').addEventListener('click', (e)=>{
  if(e.target === document.getElementById('celebration')) document.getElementById('celebration').style.display='none';
});

/* ---------- Init ---------- */
window.addEventListener('load', ()=>{
  buildPools();
  setProgressPercent(0);
  document.getElementById('targetLabel').textContent = TARGET_STREAK_FIXED;
  document.getElementById('soundToggle').addEventListener('change', (e)=> soundEnabled = e.target.checked);
});
</script>
</body>
</html>

