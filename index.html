<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Present Tense Practice — Manga Style (Blue background, Orange card)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --page-dark-1: #0b3d91;    /* deep blue top */
    --page-dark-2: #062a6b;    /* deep blue bottom */
    --panel: #ffffff;          /* white card background */
    --accent: #ff7aa2;         /* pink accent (kept for buttons) */
    --accent-dark: #e65b8a;
    --orange-card: #ff8c2b;    /* orange for the answer box */
    --text-dark: #0b1b2b;      /* dark text for readability on white */
    --muted: #4b5b66;
    --panel-border: rgba(11,27,43,0.06);
  }

  html,body{
    height:100%;
    margin:0;
    font-family:"Montserrat","Noto Sans JP",system-ui,sans-serif;
    background: linear-gradient(180deg, var(--page-dark-1) 0%, var(--page-dark-2) 100%);
    color:var(--panel);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }

  /* Outer container (white card sits on dark blue background) */
  .wrap{
    width:100%;
    max-width:980px;
    background: transparent;
    border-radius:18px;
    padding:18px;
    box-sizing:border-box;
  }

  /* White panel (main UI) */
  .panel{
    background: var(--panel);
    color: var(--text-dark);
    border-radius:14px;
    padding:20px;
    box-shadow: 0 18px 40px rgba(2,8,23,0.35);
    border: 1px solid var(--panel-border);
  }

  header{display:flex;gap:16px;align-items:center;margin-bottom:14px;}
  .logo{
    width:84px;height:84px;border-radius:12px;
    background: linear-gradient(135deg,#fff,#fff6f8);
    display:flex;align-items:center;justify-content:center;font-size:28px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    border:1px solid rgba(0,0,0,0.04);
    color:var(--accent-dark);
  }
  h1{font-size:26px;margin:0;color:var(--accent-dark);letter-spacing:0.6px;}
  p.lead{margin:0;color:var(--muted);font-size:15px;}

  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px;}
  .stats{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--text-dark);}
  .statBox{background:linear-gradient(180deg,#fff,#fafafa);padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);font-size:15px;color:var(--text-dark);font-weight:800;}

  /* Orange answer card: larger, orange background, white main text */
  #card{
    min-height:120px;               /* larger height */
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;                 /* larger font */
    font-weight:900;
    color:#ffffff;                   /* main sentence text in white */
    border-radius:14px;
    padding:22px;
    background: linear-gradient(180deg,var(--orange-card), #ff7a1a);
    border:2px solid rgba(0,0,0,0.06);
    margin-bottom:16px;
    text-align:center;
    line-height:1.2;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  }

  /* If we need a small label inside the card (e.g., "Order the sentence"), show it in black */
  #card .label {
    display:block;
    font-size:14px;
    font-weight:800;
    color:#000000; /* black label */
    margin-bottom:8px;
  }

  /* Order box: white text on orange would be low contrast; keep white background and black text */
  #orderBox{
    min-height:72px;
    border-radius:12px;
    padding:14px;
    background: #ffffff;
    border:1px solid rgba(0,0,0,0.04);
    display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:14px;flex-wrap:wrap;
    color:var(--text-dark);
    font-size:18px;                 /* larger font */
    font-weight:800;
  }

  .chosenWord{
    display:inline-block;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#fff,#f6f6f6);border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:900;color:var(--text-dark);font-size:18px;
  }

  #options{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:14px}
  button.optionBtn{
    background:linear-gradient(180deg,#ffffff,#fff7fb);
    border:1px solid rgba(0,0,0,0.06);
    padding:12px 20px;border-radius:14px;font-weight:900;color:var(--text-dark);
    cursor:pointer;box-shadow:0 8px 22px rgba(2,8,23,0.08);transition:transform .12s, background .12s;font-size:18px;
  }
  button.optionBtn:hover{transform:translateY(-4px);background:linear-gradient(180deg,#fff,#fff7fb)}
  button.optionBtn.chosen{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border-color:rgba(0,0,0,0.06)}

  #feedback{min-height:48px;text-align:center;font-weight:900;color:var(--text-dark);margin-bottom:12px;font-size:18px}
  .controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:10px}
  .btnPrimary{background:var(--accent);color:#fff;padding:12px 18px;border-radius:14px;border:none;font-weight:900;cursor:pointer;font-size:16px}
  .btnSecondary{background:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;color:var(--text-dark);font-weight:800;font-size:15px}

  .progressWrap{width:280px;height:16px;background:#fff3e6;border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,0.03)}
  .progressBar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-dark));width:0%}
  .configRow{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px}
  input[type="number"]{width:90px;padding:10px;border-radius:10px;border:1px solid #e6eef3;font-size:15px}
  input[type="text"]{padding:10px;border-radius:10px;border:1px solid #e6eef3;font-size:15px}
  select{padding:10px;border-radius:10px;border:1px solid #e6eef3;font-size:15px}
  .small{font-size:14px;color:var(--muted)}

  @media (max-width:520px){
    .logo{width:64px;height:64px;font-size:24px}
    h1{font-size:20px}
    #card{font-size:20px;padding:16px}
    button.optionBtn{padding:10px 12px;font-size:16px}
    .statBox{font-size:13px;padding:8px 10px}
    #orderBox{font-size:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel" aria-live="polite">
      <header>
        <div class="logo">MANGA</div>
        <div>
          <h1 id="title">Present Tense Practice — Manga Style</h1>
          <p class="lead">Levels, teacher report, sound effects, and streak progress</p>
        </div>
      </header>

      <!-- Setup -->
      <div id="setup">
        <div class="configRow">
          <input id="studentNameInput" type="text" placeholder="Your name">
          <label style="font-weight:800">Target streak</label>
          <input id="targetInput" type="number" min="1" max="100" value="25">
          <label style="font-weight:800">Difficulty</label>
          <select id="levelSelect">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
            <option value="mixed">Mixed</option>
          </select>
          <button class="btnPrimary" id="startBtn">START</button>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:10px">
          <label class="small"><input id="soundToggle" type="checkbox" checked> Sound effects</label>
          <button class="btnSecondary" id="downloadTemplate">Download Teacher Report (empty CSV)</button>
        </div>

        <div style="text-align:center;color:var(--muted);font-size:14px">Choose level; teacher report logs each attempt and can be downloaded as CSV.</div>
      </div>

      <!-- Game -->
      <div id="game" style="display:none">
        <div class="topbar">
          <div class="stats">
            <div class="statBox" id="score">Score: 0</div>
            <div class="statBox" id="timer">Time: 0s</div>
            <div class="statBox" id="streakBox">Streak: 0</div>
          </div>
          <div style="font-size:14px;color:var(--muted)">Player: <strong id="playerName">—</strong></div>
        </div>

        <!-- Orange answer card -->
        <div id="card"><span id="cardLabel" class="label" style="display:none"></span><span id="cardText">A sentence or instruction will appear here</span></div>

        <div id="orderBox" aria-live="polite"></div>

        <div id="options" role="group" aria-label="Options"></div>

        <div id="feedback" aria-live="assertive"></div>

        <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-top:10px">
          <div class="progressWrap" title="Streak progress">
            <div id="progressBar" class="progressBar"></div>
          </div>
          <div style="font-weight:900;color:var(--text-dark);font-size:15px" id="progressText">0 / 25</div>
        </div>

        <div class="controls">
          <button class="btnPrimary" id="goOn" style="display:none">Next</button>
          <button class="btnSecondary" id="resetOrder" style="display:none">Reset Order</button>
          <button class="btnSecondary" id="restart" style="display:none">Restart</button>
          <button class="btnSecondary" id="downloadReport" style="display:none">Download Report (CSV)</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Sentence banks: 20 each (affirmative, negative, interrogative, continuous) ---------- */
const PS_aff = [
  "She usually walks to school.",
  "He plays the guitar every afternoon.",
  "They enjoy quiet mornings together.",
  "My cat sleeps on my backpack.",
  "I like how this coffee smells.",
  "We read the newspaper every morning.",
  "The bus arrives at eight o'clock.",
  "Tom studies French at university.",
  "Anna works in a small bakery.",
  "Birds fly south in winter.",
  "The shop opens at nine every day.",
  "He drinks green tea after lunch.",
  "Students practice vocabulary every evening.",
  "She always helps her neighbors.",
  "The sun rises in the east.",
  "He writes emails every morning.",
  "We celebrate birthdays with cake.",
  "The teacher explains the lesson clearly.",
  "She takes the dog for a walk daily.",
  "They visit the museum on weekends."
];

const PS_neg = [
  "She doesn't like cold pizza.",
  "They don't study on Sundays.",
  "He does not enjoy long movies.",
  "I don't drink soda anymore.",
  "The cat doesn't sleep in its bed.",
  "We don't watch TV at night.",
  "He doesn't own a car.",
  "She does not eat meat.",
  "They don't arrive early.",
  "I don't understand this word.",
  "She doesn't answer her phone often.",
  "We don't use that old computer anymore.",
  "He doesn't believe the rumor.",
  "They don't accept late homework.",
  "I don't remember his name.",
  "She doesn't drive to work.",
  "He doesn't like loud music.",
  "We don't go out when it rains.",
  "The store doesn't open on Sundays.",
  "He doesn't speak Spanish."
];

const PS_int = [
  "Do you like spicy food?",
  "Does she play the violin?",
  "Do they live near here?",
  "Does he enjoy swimming?",
  "Do we have class today?",
  "Do you speak English?",
  "Does it rain a lot here?",
  "Do they know the answer?",
  "Does she work on Saturdays?",
  "Do I need to bring a book?",
  "Do you usually study in the morning?",
  "Does he visit his grandparents every week?",
  "Do they play chess after school?",
  "Does she cook for the family?",
  "Do we meet at the library?",
  "Do you understand the instructions?",
  "Does he take the train to work?",
  "Do they practice every day?",
  "Does she prefer tea or coffee?",
  "Do I have to finish this today?"
];

const PC_aff = [
  "She's studying English right now.",
  "They are cooking dinner together.",
  "He's drawing a robot at the moment.",
  "I'm listening to music.",
  "We're walking to the bus stop.",
  "She is reading a new novel.",
  "They are playing football in the park.",
  "He is fixing his bicycle.",
  "I'm watching a documentary.",
  "We are preparing for the exam.",
  "She is practicing the piano this afternoon.",
  "They are building a model in the workshop.",
  "He is cleaning his room right now.",
  "I'm checking my email at the moment.",
  "We are learning a new song today.",
  "She is talking on the phone now.",
  "They are planting flowers in the garden.",
  "He is repairing the fence this morning.",
  "I'm making a sandwich right now.",
  "We are discussing the project together."
];

/* ---------- State ---------- */
let current = {};
let score = 0;
let timer = 0;
let timerInterval = null;
let playerName = "";
let consecutiveCorrect = 0;
let TARGET_STREAK = 25;
let attemptsLog = [];
let soundEnabled = true;

/* ---------- Audio (WebAudio) ---------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
function playTone(type){
  if(!soundEnabled || !audioCtx) return;
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  if(type === 'correct'){
    o.frequency.setValueAtTime(880, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.01);
    o.frequency.exponentialRampToValueAtTime(1320, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  } else {
    o.frequency.setValueAtTime(220, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.08, now+0.01);
    o.frequency.exponentialRampToValueAtTime(160, now+0.12);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  }
  o.start(now); o.stop(now+0.3);
}

/* ---------- Utilities ---------- */
function clearTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval = null; } }
function startTimer(){ clearTimer(); timer = 0; document.getElementById("timer").textContent = "Time: 0s"; timerInterval = setInterval(()=>{ timer++; document.getElementById("timer").textContent = "Time: " + timer + "s"; },1000); }
function normalizeString(s){ if(!s) return ""; return s.replace(/[\u2018\u2019\u201C\u201D]/g,"'").replace(/[?.,!;:()"]/g,"").replace(/\s+/g," ").trim().toLowerCase(); }
function shuffleArray(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function updateStreakUI(){ document.getElementById("streakBox").textContent = "Streak: " + consecutiveCorrect; const pb = document.getElementById("progressBar"); const pct = Math.min(100, Math.round((consecutiveCorrect / TARGET_STREAK) * 100)); pb.style.width = pct + "%"; document.getElementById("progressText").textContent = consecutiveCorrect + " / " + TARGET_STREAK; }

/* ---------- Level pool builder ---------- */
function buildPool(level){
  const sliceFor = (arr) => {
    if(level === 'easy') return arr.slice(0,8);
    if(level === 'medium') return arr.slice(8,15);
    if(level === 'hard') return arr.slice(15,20);
    return arr.slice(); // mixed: full bank
  };
  const pool = [].concat(sliceFor(PS_aff), sliceFor(PS_neg), sliceFor(PS_int), sliceFor(PC_aff));
  return shuffleArray(pool);
}

/* ---------- Start button ---------- */
document.getElementById("startBtn").addEventListener("click", ()=>{
  const name = document.getElementById("studentNameInput").value.trim();
  const t = parseInt(document.getElementById("targetInput").value, 10);
  const level = document.getElementById("levelSelect").value;
  soundEnabled = document.getElementById("soundToggle").checked;
  if(!name){ alert("Please enter your name to start"); return; }
  if(!t || t < 1){ alert("Please set a valid target streak (1 or more)"); return; }
  playerName = name;
  TARGET_STREAK = t;
  document.getElementById("playerName").textContent = playerName;
  document.getElementById("setup").style.display = "none";
  document.getElementById("game").style.display = "block";
  consecutiveCorrect = 0; score = 0; attemptsLog = [];
  document.getElementById("score").textContent = "Score: " + score;
  updateStreakUI();
  window.__sentencePool = buildPool(level);
  nextQuestion();
});

/* ---------- Next question ---------- */
function nextQuestion(){
  if(consecutiveCorrect >= TARGET_STREAK) return;
  clearTimer();
  document.getElementById("feedback").textContent = "";
  document.getElementById("goOn").style.display = "none";
  document.getElementById("resetOrder").style.display = "none";
  document.getElementById("orderBox").innerHTML = "";
  document.getElementById("options").innerHTML = "";
  document.getElementById("cardText").textContent = "";
  document.getElementById("cardLabel").style.display = "none";

  if(!window.__sentencePool || window.__sentencePool.length === 0){
    window.__sentencePool = shuffleArray(PS_aff.concat(PS_neg, PS_int, PC_aff));
  }
  const text = window.__sentencePool.pop();
  let correctLabel = PS_aff.includes(text) || PS_neg.includes(text) || PS_int.includes(text) ? "Present Simple" : "Present Continuous";
  current = { text, correct: correctLabel, mode: Math.random() < 0.5 ? "multiple" : "order", typed: [], startTime: Date.now() };
  renderQuestion();
}

/* ---------- Render ---------- */
function renderQuestion(){
  startTimer();
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  if(current.mode === "multiple"){
    // show sentence in white on orange card
    document.getElementById("cardText").textContent = current.text;
    document.getElementById("cardLabel").style.display = "none";
    const choices = ["Present Simple","Present Continuous"];
    choices.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className = "optionBtn";
      btn.textContent = opt;
      btn.onclick = ()=> checkAnswer(opt);
      optionsDiv.appendChild(btn);
    });
  } else {
    document.getElementById("cardLabel").style.display = "block";
    document.getElementById("cardLabel").textContent = "Order the sentence";
    document.getElementById("cardText").textContent = ""; // sentence will be shown in orderBox or after completion
    const cleaned = current.text.replace(/[\u2018\u2019\u201C\u201D]/g,"'");
    const words = cleaned.replace(/[?.,!;:()"]/g,"").split(/\s+/).filter(Boolean);
    if(words.length <= 1){ current.mode = "multiple"; renderQuestion(); return; }

    let shuffled; const MAX_ATTEMPTS = 12; let attempts = 0;
    do{ shuffled = shuffleArray(words); attempts++; if(attempts>=MAX_ATTEMPTS) break; } while(shuffled.join(" ") === words.join(" "));

    current.originalWords = words; current.shuffledWords = shuffled; current.typed = [];
    shuffled.forEach((w, idx)=>{
      const btn = document.createElement("button");
      btn.className = "optionBtn";
      btn.textContent = w;
      btn.dataset.idx = idx;
      btn.onclick = ()=> pickWord(w, btn);
      optionsDiv.appendChild(btn);
    });

    const resetBtn = document.getElementById("resetOrder");
    resetBtn.style.display = "inline-block";
    resetBtn.onclick = resetOrder;
    updateOrderBox();
  }
}

/* ---------- Order helpers ---------- */
function updateOrderBox(){
  const box = document.getElementById("orderBox");
  box.innerHTML = "";
  if(current.typed.length === 0){ box.textContent = "Selected words will appear here (click a selected word to undo)."; return; }
  current.typed.forEach((w,i)=>{
    const span = document.createElement("span");
    span.className = "chosenWord";
    span.textContent = w;
    span.onclick = ()=> undoWord(i);
    box.appendChild(span);
  });
}
function undoWord(index){
  const optionsDiv = document.getElementById("options");
  const buttons = Array.from(optionsDiv.querySelectorAll("button"));
  buttons.forEach(b => { b.disabled = false; b.classList.remove("chosen"); });
  current.typed = current.typed.slice(0, index);
  buttons.forEach(b=>{ if(current.typed.includes(b.textContent)){ b.classList.add("chosen"); b.disabled = true; } });
  updateOrderBox();
  document.getElementById("feedback").textContent = "Word removed. Continue.";
}
function resetOrder(){
  current.typed = [];
  const optionsDiv = document.getElementById("options");
  Array.from(optionsDiv.querySelectorAll("button")).forEach(b=>{ b.disabled = false; b.classList.remove("chosen"); });
  updateOrderBox();
  document.getElementById("feedback").textContent = "Order reset.";
}

/* ---------- Logging helper (teacher report) ---------- */
function logAttempt(entry){
  attemptsLog.push(entry);
  document.getElementById("downloadReport").style.display = "inline-block";
}

/* ---------- Correct / Incorrect handling ---------- */
function handleCorrect(selected){
  score++; consecutiveCorrect++; updateStreakUI();
  document.getElementById("score").textContent = "Score: " + score;
  document.getElementById("feedback").textContent = ["Great!","Perfect!","Well done!","Excellent!"][Math.floor(Math.random()*4)];
  playTone('correct');
  clearTimer();
  document.querySelectorAll("#options .optionBtn").forEach(b=>b.disabled=true);
  document.getElementById("goOn").style.display = "inline-block";
  document.getElementById("resetOrder").style.display = "none";
  document.getElementById("goOn").onclick = nextQuestion;

  const timeTaken = Math.round((Date.now() - current.startTime)/1000);
  logAttempt({
    timestamp: new Date().toISOString(),
    student: playerName,
    sentence: current.text,
    mode: current.mode,
    selected: selected || "",
    correctLabel: current.correct,
    correct: true,
    timeTaken,
    streak: consecutiveCorrect
  });

  if(consecutiveCorrect >= TARGET_STREAK){
    document.getElementById("feedback").textContent = "CONGRATULATIONS! You reached " + TARGET_STREAK + " correct in a row!";
    clearTimer();
    document.querySelectorAll("#options .optionBtn").forEach(b=>{ b.disabled = true; b.classList.add("chosen"); });
    document.getElementById("goOn").style.display = "none";
    const restart = document.getElementById("restart");
    restart.style.display = "inline-block";
    restart.onclick = ()=> {
      consecutiveCorrect = 0; score = 0; attemptsLog = [];
      document.getElementById("score").textContent = "Score: " + score;
      updateStreakUI(); document.getElementById("feedback").textContent = ""; restart.style.display = "none"; document.getElementById("downloadReport").style.display = "none";
      window.__sentencePool = shuffleArray(PS_aff.concat(PS_neg, PS_int, PC_aff));
      nextQuestion();
    };
  }
}

/* ---------- Interaction handlers ---------- */
function pickWord(word, btn){
  if(btn.disabled) return;
  btn.classList.add("chosen"); btn.disabled = true;
  current.typed.push(word); updateOrderBox();
  const typed = normalizeString(current.typed.join(" "));
  const correct = normalizeString(current.originalWords.join(" "));
  if(typed === correct){
    // show the full sentence in the orange card (white text)
    document.getElementById("cardLabel").style.display = "none";
    document.getElementById("cardText").textContent = current.originalWords.join(" ");
    handleCorrect(current.typed.join(" "));
    return;
  }
  if(current.typed.length === current.originalWords.length){
    consecutiveCorrect = 0; updateStreakUI();
    document.getElementById("feedback").textContent = "Incorrect. Correct sentence shown.";
    document.getElementById("cardLabel").style.display = "none";
    document.getElementById("cardText").textContent = current.originalWords.join(" ");
    playTone('incorrect');
    clearTimer();
    document.querySelectorAll("#options .optionBtn").forEach(b=>b.disabled=true);
    document.getElementById("goOn").style.display = "inline-block";
    document.getElementById("resetOrder").style.display = "none";
    document.getElementById("goOn").onclick = nextQuestion;

    const timeTaken = Math.round((Date.now() - current.startTime)/1000);
    logAttempt({
      timestamp: new Date().toISOString(),
      student: playerName,
      sentence: current.text,
      mode: current.mode,
      selected: current.typed.join(" "),
      correctLabel: current.correct,
      correct: false,
      timeTaken,
      streak: consecutiveCorrect
    });
    return;
  }
  document.getElementById("feedback").textContent = "Keep selecting...";
}
function checkAnswer(choice){
  if(choice === current.correct){
    // show sentence in orange card
    document.getElementById("cardText").textContent = current.text;
    handleCorrect(choice);
  } else {
    consecutiveCorrect = 0; updateStreakUI();
    document.getElementById("feedback").textContent = ["Try again","Almost","Check the sentence"][Math.floor(Math.random()*3)];
    playTone('incorrect');
    const timeTaken = Math.round((Date.now() - current.startTime)/1000);
    logAttempt({
      timestamp: new Date().toISOString(),
      student: playerName,
      sentence: current.text,
      mode: current.mode,
      selected: choice,
      correctLabel: current.correct,
      correct: false,
      timeTaken,
      streak: consecutiveCorrect
    });
  }
}

/* ---------- CSV download ---------- */
function csvEscape(s){ if(s === null || s === undefined) return ""; return '"' + String(s).replace(/"/g,'""') + '"'; }
function downloadCSV(filename, rows){
  const header = ["timestamp","student","sentence","mode","selected","correctLabel","correct","timeTaken_s","streak"];
  const lines = [header.join(",")];
  rows.forEach(r=>{
    lines.push([
      csvEscape(r.timestamp),
      csvEscape(r.student),
      csvEscape(r.sentence),
      csvEscape(r.mode),
      csvEscape(r.selected),
      csvEscape(r.correctLabel),
      csvEscape(r.correct),
      csvEscape(r.timeTaken),
      csvEscape(r.streak)
    ].join(","));
  });
  const csv = lines.join("\n");
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- Buttons ---------- */
document.getElementById("downloadReport").addEventListener("click", ()=>{
  if(attemptsLog.length === 0){ alert("No attempts logged yet."); return; }
  const filename = `${playerName || "student"}_teacher_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
  downloadCSV(filename, attemptsLog);
});
document.getElementById("downloadTemplate").addEventListener("click", ()=>{
  const filename = `teacher_report_template.csv`;
  downloadCSV(filename, []);
});
document.getElementById("soundToggle").addEventListener("change", (e)=>{ soundEnabled = e.target.checked; if(soundEnabled && audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); });

/* ---------- Cleanup ---------- */
window.addEventListener("beforeunload", ()=> clearTimer());
</script>
</body>
</html>


